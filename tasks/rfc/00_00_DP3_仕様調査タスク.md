# Delta Pro3 仕様調査タスク

## 1. MQTT/Protobuf 仕様調査

- [x] MQTT ブローカーの接続方式調査
  - 例: mqtt.ecoflow.com への接続方法、認証情報の取得方法
  - **参考: ioBroker.ecoflow-mqtt, GitHub issue #270**
  - EcoFlow 公式 MQTT ブローカー(mqtt.ecoflow.com)に接続するには、以下の認証情報が必要:
    - UserName(例: app-xxxx...)
    - UserID(19 桁の数字)
    - UserPassword(英数字)
    - ClientID(ANDROID_xxxx... で始まる文字列)
  - 認証情報の取得方法:
    1. [ecoflow-withoutflow/cloud-mqtt/ecoflow_get_mqtt_login.sh](https://github.com/mmiller7/ecoflow-withoutflow/blob/main/cloud-mqtt/ecoflow_get_mqtt_login.sh) スクリプトを使う
    2. [energychain.github.io/site_ecoflow_mqtt_credentials/](https://energychain.github.io/site_ecoflow_mqtt_credentials/) の Web サイトで取得 **(この方法で認証情報を取得済み)**。このサイトでは、EcoFlow アカウントのメールアドレス、パスワード、およびデバイスのシリアル番号を入力することで MQTT 認証情報を取得できる。
    3. ioBroker.ecoflow-mqtt アダプタの「ボタンを押す」機能(EcoFlow アカウントのユーザー名・パスワードが必要)
  - MQTT ブローカーのアドレスやポートは通常デフォルト(mqtt.ecoflow.com:1883)
  - 場合によっては Web サイト ② で異なるブローカーアドレスが返ることもあるので注意
  - 取得した認証情報を使い、MQTT クライアント(Node-RED や ioBroker 等)で接続設定を行う
  - 参考: [ioBroker.ecoflow-mqtt README](https://github.com/foxthefox/ioBroker.ecoflow-mqtt#ef-credentials)
- [x] Delta Pro3 の MQTT トピック構造調査
  - 例: /app/xxxx/thing/property/get など、どのトピックでどんなデータが流れるか
  - **概要:** Delta Pro 3 の MQTT 通信では、標準的なトピック構造（`set`, `set_reply`, `get`, `get_reply`, 定期更新）が使用されます。ペイロードは全て Protobuf 形式で、特に定期更新メッセージはヘッダーの`seq`を用いた XOR デコードが必要です。主要な`cmdId`（1, 2, 3, 4, 17, 21, 22 など）ごとに異なる情報（基本ステータス、詳細電力情報、設定値、コマンド送受信など）が扱われます。
  - **詳細なトピック構造、メッセージ形式、Protobuf 定義、コマンド ID、および `ioBroker.ecoflow-mqtt/lib/dict_data/ef_deltapro3_data.js` の解析結果については、[こちらの詳細ドキュメント](tasks/rfc/00_01_DP3_MQTTトピック構造詳細.md) を参照してください。**
- [ ] Delta Pro3 の MQTT メッセージ形式調査
  - 例: Protobuf 形式か JSON 形式か、バイナリかテキストか
  - **確定事項:** Delta Pro3 の MQTT メッセージのペイロードは **Protobuf (Protocol Buffers)** 形式。
    - これは JSON 形式ではなく、バイナリベースのシリアライズフォーマット。
    - Node-RED 等で直接メッセージを見ると "Invalid JSON string" のように表示されるのはこのため。
  - **伝送形式:**
    - Protobuf メッセージは通常、生の**バイナリデータ**として MQTT ペイロードに格納される。
    - 特殊なエンコーディング(Base64 等)は通常行われない。
  - **メッセージ構造のヒント (PowerStream 等の既存実装より類推):**
    - EcoFlow 独自のヘッダー構造を持つ可能性が高い。
    - ヘッダーには `pdata` (Protobuf ペイロード)、`cmd_id`、`seq` (シーケンス番号)、`enc_type` などが含まれる。
  - **特に注意すべき点 (ハートビートメッセージ):**
    - トピック `app/device/property/<DEVICE_SN>` で受信する定期的状態更新(ハートビート)メッセージ (cmdId 1, 2, 3, 4, 28 など) の `pdata` 部分は、そのままでは Protobuf としてデコードできない。
    - **ヘッダー内の `seq` (シーケンス番号) を使用して、`pdata` の各バイトを XOR デコードする必要がある** (主に `seq` の下位 1 バイトとの XOR)。
    - XOR デコード後に Protobuf としてパース可能になる。
    - (参考: `hassio-ecoflow-cloud` GitHub Issue #193, `michaelahern` 氏のコメント)
  - **`get_reply` メッセージ:**
    - `app/<USER_ID>/<DEVICE_SN>/thing/property/get_reply` トピックで受信するメッセージは、通常 XOR デコードは不要で、直接 Protobuf としてデコード可能。
    - 1 つの `get_reply` に複数の `cmdId` を持つ Protobuf メッセージが含まれることがある。
  - **参考情報源:**
    - `ioBroker.ecoflow-mqtt` リポジトリ (特に `lib/parser.js` や `.proto` ファイル群)
    - `hassio-ecoflow-cloud` GitHub Issue #193 (Delta Pro Ultra, 特に `michaelahern` 氏の .proto ファイルやデコードに関するコメント)
    - `hassio-ecoflow-cloud` GitHub Issue #270 (Delta Pro 3)
- [ ] Protobuf メッセージのサンプル収集
  - 例: Node-RED や ioBroker 等で実際の生データをキャプチャ
  - **目的:** Delta Pro3 が MQTT で送受信する実際の Protobuf メッセージの生データを収集し、後のスキーマ解析やデコード処理実装の基礎とする。
  - **準備するもの:**
    - EcoFlow Delta Pro 3 実機
    - MQTT ブローカー接続情報 (アドレス、ポート、認証情報)
    - MQTT クライアントツール (以下いずれか、または複数):
      - **MQTT Explorer:** GUI でトピック購読、メッセージ表示・コピーが容易。
      - **Node-RED:** フローベース。MQTT ノードで購読しファイル保存やデバッグ表示。
      - **ioBroker と `ioBroker.ecoflow-mqtt` アダプター:** 既存環境があればデバッグログ活用。
      - **コマンドライン MQTT クライアント (mosquitto_sub 等):** CUI での購読・保存。
  - **収集手順:**
    1.  **MQTT ブローカーに接続:** 準備したツールと認証情報で接続する。
    2.  **対象トピックを購読:**
        - `app/device/property/<DEVICE_SN>` (ハートビート)
        - `app/<USER_ID>/<DEVICE_SN>/thing/property/get_reply` (状態取得応答)
        - `app/<USER_ID>/<DEVICE_SN>/thing/property/set` (コマンド送信)
        - `app/<USER_ID>/<DEVICE_SN>/thing/property/set_reply` (コマンド応答)
        - (SN と UserID は自身のものに置き換える。必要に応じてワイルドカード `#` や `+` を使用)
    3.  **データ収集の実行:**
        - **状態更新 (ハートビート):**
          - `app/device/property/<DEVICE_SN>` をしばらく購読し、複数パターンのメッセージを収集。
          - メッセージ生データに加え、ヘッダーの `cmdId`, `seq` も記録 (XOR デコードに必要)。
        - **状態取得 (`get_reply`):**
          - 可能であれば、`get` リクエストを送信し、対応する `get_reply` メッセージを収集。
          - 送信した `get` リクエストの内容も記録。
        - **コマンド送受信 (`set`, `set_reply`):**
          - EcoFlow アプリ等で様々な操作 (AC ON/OFF, 充電上限変更, 放電下限変更, 電源 ON/OFF 等) を行う。
          - 操作時に `set` トピックに送られるメッセージと、`set_reply` で返る応答をセットで収集。
          - **行った操作内容を必ず記録する。** (例: 「AC 出力を ON」)
    4.  **記録・保存:**
        - 収集したデータはテキストファイル、CSV、JSON ファイル等に保存する。
        - 各サンプルについて以下情報を推奨:
          - **日時**
          - **トピック名**
          - **メッセージ生データ (HEX 文字列 or バイト配列)**
          - **ヘッダー情報 (判明すれば):** `cmdId`, `seq`, `src`, `dest`, `enc_type` 等
          - **操作内容 (コマンドの場合)**
          - **備考**
  - **収集量の目安:** 多様な操作、多様な状態でのメッセージをできるだけ多く。設定値の僅かな違いによるメッセージの変化も重要。
- [ ] Protobuf スキーマ(.proto ファイル)の入手・推測
  - 例: 既存リポジトリや issue、ioBroker.ecoflow-mqtt の実装を参考にする
  - **最優先調査対象:**
    - **`foxthefox/ioBroker.ecoflow-mqtt` リポジトリ:**
      - `lib/` ディレクトリ配下や `doc/devices/` 配下に、Delta Pro 3 (DP3) または Delta Pro Ultra (DPU) 向けの `.proto` ファイル、あるいはそれらに関連するスキーマ定義が含まれている可能性が高い。
      - Changelog に "new Delta Pro 3 implementation" (v1.3.0), "preparations for DeltaPro3 decode" (v1.0.3) の記述あり。
      - 特に `lib/ecoflow_data.js` や `lib/parser.js`、`.proto` ファイル群を確認。
    - **`tolwi/hassio-ecoflow-cloud` GitHub Issue #193 (Delta Pro Ultra):**
      - `michaelahern` 氏が提供している以下の `.proto` ファイルおよび `pbdesc.txt` は DP3 にも流用・応用できる可能性が高い:
        - `AppShowHeartbeatReport.proto` (cmdId 1)
        - `BackendRecordHeartbeatReport.proto` (cmdId 2)
        - `AppParaHeartbeatReport.proto` (cmdId 3)
        - `BpInfoReport.proto` (cmdId 4)
        - `pbdesc.txt` (上記 .proto を生成するための FileDescriptorSet)
      - これらのファイルは、収集したサンプルデータの `pdata` (XOR デコード後) を解析する際に使用する。
  - **スキーマ構造のヒント:**
    - EcoFlow の Protobuf メッセージは、共通のヘッダー構造と、`cmdId` ごとに異なるペイロード (`pdata`) 構造を持つことが多い。
    - `ioBroker.ecoflow-mqtt` で PowerStream 用に定義されているヘッダー構造も参考になる可能性がある。
  - **入手・推測の手順:**
    1.  上記リポジトリ・Issue から `.proto` ファイルやスキーマ定義をダウンロード・収集する。
    2.  収集したサンプルメッセージ (特に XOR デコード済みの `pdata`) と照らし合わせ、対応する `cmdId` のスキーマを特定する。
    3.  オンラインの Protobuf デコーダー (例: `protobuf-decoder.netlify.app`) やローカルツール (`protoc --decode_raw` 等) を使用し、収集したスキーマ定義を適用してメッセージが正しくデコードできるか検証する。
    4.  既存のスキーマでデコードできないフィールドや、DP3 特有のフィールドがある場合は、サンプルデータの値の変動パターンからデータ型 (int32, float, string, bool, enum, nested message 等) やフィールド番号を推測し、`.proto` ファイルを拡張・修正する。
    5.  コマンド送信 (`set` トピック) 用のメッセージスキーマも同様に、送信データと応答データから推測・定義する。
  - **スキーマ推測ツール (補助的利用):**
    - 生のバイナリデータからある程度スキーマを推測するツール (例: `protoscope`, `blackboxprotobuf`) も存在するが、完全なスキーマ生成は難しいため、あくまで補助的な手段として利用を検討。
  - **ドキュメント化:**
    - 特定・推測できたスキーマは、メッセージタイプごとに `.proto` ファイルとして保存・管理する。
    - 各フィールドの意味が判明次第、コメントとして追記する。
- [ ] 主要なフィールドと値の意味の特定

  - 例: バッテリー残量、AC 出力、ソーラー入力など、どのフィールドが何を表すか
  - **参考情報源:**
    - [hassio-ecoflow-cloud Issue #193, #270](https://github.com/tolwi/hassio-ecoflow-cloud/issues/193)
    - [ioBroker.ecoflow-mqtt/lib/ecoflow_data.js](https://github.com/foxthefox/ioBroker.ecoflow-mqtt)
    - 実際のデバッグデータ例・コミュニティの推測
  - **代表的な cmdId: 1, 2, 3, 4, 32 など**
    - cmdId 1: アプリ表示用ハートビート(基本ステータス)
    - cmdId 2: バックエンド記録用ハートビート(詳細電力情報)
    - cmdId 3: アプリパラメータハートビート(設定値など)
    - cmdId 4: バッテリーパック情報
    - cmdId 32: 詳細な電力・バッテリー情報(DP3/Ultra 系で多用)
  - **主要フィールド例(cmdId 32, foxthefox 氏の推測より)**

    | フィールド名 | フィールド番号 | 型    | 意味・推定内容(例)              |
    | ------------ | -------------- | ----- | ------------------------------- |
    | voltage68    | 68             | float | AC 出力電圧(例: 119V)           |
    | current69    | 69             | float | AC 出力電流                     |
    | voltage149   | 149            | float | DC 出力電圧(例: 24V)            |
    | current150   | 150            | float | DC 出力電流                     |
    | voltage151   | 151            | float | AC 出力電圧(別系統?)            |
    | unknown169   | 169            | float | 出力電力(W)?                    |
    | voltage197   | 197            | float | AC 出力電圧                     |
    | voltage244   | 244            | float | バッテリー電圧(例: 52V)         |
    | unknown245   | 245            | float | バッテリー電流?                 |
    | unknown247   | 247            | int32 | フル容量(例: 80000mAh)          |
    | unknown249   | 249            | int32 | 残容量(例: 26400mAh)            |
    | unknown256   | 256            | int32 | 最小セル電圧(例: 3309 → 3.309V) |
    | unknown257   | 257            | int32 | 最大セル電圧(例: 3313 → 3.313V) |
    | voltage264   | 264            | float | バッテリー電圧                  |
    | voltage266   | 266            | float | バッテリー電圧(別系統?)         |
    | unknown267   | 267            | float | 充電上限/下限設定値?            |
    | unknown293   | 293            | int32 | 120000(容量?)                   |
    | unknown294   | 294            | int32 | 2000(容量?)                     |
    | unknown295   | 295            | int32 | 300000(容量?)                   |
    | unknown296   | 296            | int32 | 60000(容量?)                    |
    | voltage318   | 318            | float | バッテリー電圧                  |
    | unknown337   | 337            | float | 充電上限(%)?                    |
    | unknown340   | 340            | float | バッテリー電流?                 |
    | voltage341   | 341            | float | バッテリー電圧                  |
    | unknown369   | 369            | float | MPPT 出力電力(例: 400W)         |
    | unknown377   | 377            | float | MPPT 電圧(例: 57.25V)           |
    | unknown378   | 378            | float | MPPT 出力電力(例: 837W)         |
    | unknown385   | 385            | float | バッテリー電圧                  |
    | unknown386   | 386            | float | MPPT 出力電力                   |

  - **具体的な値の例**
    - voltage68: 119.3 → AC 出力電圧
    - voltage149: 24.0 → DC 出力電圧
    - unknown249: 26400 → 残容量 mAh
    - unknown337: 80 → 充電上限%?
    - unknown369: 400.9 → MPPT 出力 W
  - **備考:**
    - フィールド番号や型は、今後のサンプルデータ解析やアプリ画面との突き合わせでさらに確定・詳細化が必要。
    - 既存の .proto ファイル(例: AppShowHeartbeatReport.proto など)も参考にすること。

- [ ] コマンド送信時のメッセージ構造調査
  - 例: スイッチ ON/OFF や設定変更時の送信データの内容
  - **参考情報源:**
    - [hassio-ecoflow-cloud Issue #193, #270](https://github.com/tolwi/hassio-ecoflow-cloud/issues/193)
    - [ioBroker.ecoflow-mqtt/lib/ecoflow_data.js](https://github.com/foxthefox/ioBroker.ecoflow-mqtt)
    - 実際のデバッグデータ例(Node-RED, MQTT Explorer, **`scripts/mqtt_capture_dp3_debug.py` スクリプト等**で取得された Base64/HEX データ)。特に `scripts/mqtt_capture_dp3_debug.py` を用いることで、コマンド送信 (`set` トピック) とその応答 (`set_reply` トピック) のメッセージを対で収集し、XOR デコードや Protobuf パースの試行を通じて構造を解析するのに役立ちます。
  - **送信トピック:**
    - `app/<USER_ID>/<DEVICE_SN>/thing/property/set` : コマンド送信(HA/App → Device)
    - `app/<USER_ID>/<DEVICE_SN>/thing/property/set_reply` : コマンド応答(Device → HA/App)
  - **メッセージ形式:**
    - いずれも Protobuf 形式のバイナリデータ。
    - 通常、`set` 送信時は XOR デコード不要。
    - `set`/`set_reply` どちらも cmdId や操作内容に応じたペイロード構造。
  - **代表的なコマンド例と推定構造:**
    - **AC 出力 ON/OFF:**
      - cmdId: 32, もしくはコマンド種別ごとに異なる場合あり
      - 主要フィールド例: `ac_out_on` (bool/int), `ac_out_off` (bool/int)
    - **充電上限/下限変更:**
      - cmdId: 32, もしくは専用 cmdId
      - 主要フィールド例: `chg_soc_max` (int), `chg_soc_min` (int)
    - **X-Boost 切替:**
      - cmdId: 32, もしくは専用 cmdId
      - 主要フィールド例: `xboost_enable` (bool/int)
    - **GFCI/RCD 切替:**
      - cmdId: 32, もしくは専用 cmdId
      - 主要フィールド例: `gfci_enable` (bool/int)
    - **DC/USB 出力 ON/OFF:**
      - cmdId: 32, もしくは専用 cmdId
      - 主要フィールド例: `dc_out_on` (bool/int), `usb_out_on` (bool/int)
    - **AC 充電速度/入力電流設定:**
      - cmdId: 32, もしくは専用 cmdId
      - 主要フィールド例: `ac_chg_current` (int), `ac_chg_speed` (int)
    - **車載入力電流設定:**
      - cmdId: 32, もしくは専用 cmdId
      - 主要フィールド例: `car_in_current` (int)
  - **実際のサンプルデータ例(Base64/HEX, debug log より):**
    - AC 出力 ON/OFF: `CioKA4ABABAgGAIgASgBOANA/gFIEVADWAFwwrmugwKAAROIAQG6AQNpb3M=`
    - X-Boost ON: `CioKA8gBARAgGAIgASgBOANA/gFIEVADWAFwk7HDgQKAAROIAQG6AQNpb3M=`
    - 充電上限変更: `CioKA4gCURAgGAIgASgBOANA/gFIEVADWAFwjZCZgQKAAROIAQG6AQNpb3M=`
    - 車載入力電流変更: `CioKA6ADBxAgGAIgASgBOANA/gFIEVADWAFw9anHgQKAAROIAQG6AQNpb3M=`
    - GFCI/RCD OFF: `CioKA+gDABAgGAIgASgBOANA/gFIEVADWAFws4/AgQKAAROIAQG6AQNpb3M=`
  - **コマンド送信時の流れ:**
    1. Home Assistant や EcoFlow アプリから操作(例: AC 出力 ON)
    2. `set`トピックに対応する Protobuf メッセージを送信
    3. デバイスがコマンドを受信し、`set_reply`トピックで応答
    4. 応答メッセージには、操作結果や新しい状態が含まれる
  - **cmdId/フィールド番号の推定:**
    - 多くのコマンドは cmdId=32 のメッセージで送信される傾向(DP3/Ultra 系)
    - フィールド番号や型は、今後のサンプルデータ解析やアプリ画面との突き合わせでさらに確定・詳細化が必要
    - 既存の.proto ファイル(例: AppShowHeartbeatReport.proto, BackendRecordHeartbeatReport.proto 等)も参考にすること
  - **備考:**
    - コマンド送信時のメッセージ構造は、今後のサンプルデータ収集・解析でさらに詳細化・確定が必要
    - コマンド種別ごとに cmdId やフィールド番号が異なる場合があるため、実際の操作とデータの突き合わせが重要
    - 参考: [protobuf-decoder.netlify.app](https://protobuf-decoder.netlify.app/) でサンプルデータのデコード・解析が可能

## 2. 既存定義・構造調査

- [ ] delta_pro.py, delta2_max.py など既存デバイス定義の項目一覧化
  - 例: センサー/スイッチ/スライダー/セレクトのリストアップ
  - **参考ファイル:**
    - custom_components/ecoflow_cloud/devices/internal/delta_pro.py
    - custom_components/ecoflow_cloud/devices/internal/delta2_max.py
  - **センサー(例: Delta Pro):**
    | 種別 | エンティティ名例 | 属性/説明 |
    |--------------|-------------------------------|---------------------------------|
    | Level | bmsMaster.soc | メインバッテリー残量 |
    | Level | bmsMaster.f32ShowSoc | メインバッテリー残量(float) |
    | Capacity | bmsMaster.designCap | 設計容量 |
    | Capacity | bmsMaster.fullCap | フル容量 |
    | Capacity | bmsMaster.remainCap | 残容量 |
    | Level | bmsMaster.soh | SOH |
    | Level | ems.lcdShowSoc | 複合バッテリー残量 |
    | Watts | pd.wattsInSum | 合計入力 W |
    | Watts | pd.wattsOutSum | 合計出力 W |
    | InWatts | inv.inputWatts | AC 入力 W |
    | OutWatts | inv.outputWatts | AC 出力 W |
    | InMilliVolt | inv.acInVol | AC 入力 V |
    | OutMilliVolt | inv.invOutVol | AC 出力 V |
    | InWattsSolar | mppt.inWatts | ソーラー入力 W |
    | InVoltSolar | mppt.inVol | ソーラー入力 V |
    | InAmpSolar | mppt.inAmp | ソーラー入力 A |
    | OutWattsDc | mppt.outWatts | DC 出力 W |
    | OutVoltDc | mppt.outVol | DC 出力 V |
    | ... | ... | ...(他、多数) |
  - **スイッチ(例: Delta Pro):**
    | エンティティ名例 | 説明 |
    |--------------------------|---------------------------|
    | pd.beepState | ビーパー ON/OFF |
    | mppt.carState | DC 出力 ON/OFF |
    | inv.cfgAcEnabled | AC 出力 ON/OFF |
    | inv.cfgAcXboost | X-Boost ON/OFF |
    | pd.acautooutConfig | AC 常時出力 ON/OFF |
    | pd.watthisconfig | バックアップ電源設定 |
  - **スライダー/ナンバー(例: Delta Pro):**
    | エンティティ名例 | 説明 |
    |--------------------------|---------------------------|
    | ems.maxChargeSoc | 充電上限(%) |
    | ems.minDsgSoc | 放電下限(%) |
    | pd.bppowerSoc | バックアップリザーブ(%) |
    | ems.minOpenOilEbSoc | 発電機自動起動しきい値(%) |
    | ems.maxCloseOilEbSoc | 発電機自動停止しきい値(%) |
    | inv.cfgSlowChgWatts | AC 充電パワー(W) |
  - **セレクト(例: Delta Pro):**
    | エンティティ名例 | 説明 |
    |--------------------------|---------------------------|
    | mppt.cfgDcChgCurrent | DC 充電電流選択 |
    | pd.lcdOffSec | LCD オフタイマー |
    | pd.standByMode | スタンバイモード |
    | inv.cfgStandbyMin | AC スタンバイタイマー |
  - **Delta2 Max も同様に多数のセンサー・スイッチ・スライダー・セレクトを持つ。**
    - センサー: bms_bmsStatus.soc, mppt.inWatts, inv.inputWatts, ...
    - スイッチ: pd.beepMode, pd.dcOutState, inv.cfgAcEnabled, ...
    - スライダー: bms_emsStatus.maxChargeSoc, bms_emsStatus.minDsgSoc, ...
    - セレクト: pd.lcdOffSec, inv.standbyMin, mppt.carStandbyMin, ...
  - **備考:**
    - 各エンティティは、`custom_components/ecoflow_cloud/devices/internal/` 配下の各.py で `sensors`/`switches`/`numbers`/`selects` メソッドにより定義されている。
    - 実際の項目名・属性は const.py や各 Entity クラスの定義も参照。
    - DP3 対応時は、これら既存定義をベースに、DP3 特有の項目追加・調整を行う。
- [ ] 既存デバイスのデータパース・エンティティ生成ロジック調査
  - 例: どのようにデータを受け取り、Home Assistant のエンティティに変換しているか
  - **全体フロー:**
    1. **MQTT 受信**
       - `EcoflowMQTTClient`(`api/ecoflow_mqtt.py`)が各トピックでメッセージ受信。
       - 受信時、各デバイス(`BaseDevice`継承クラス)に `update_data(payload, topic)` を呼び出す。
    2. **データパース・格納**
       - `BaseDevice.update_data()` でトピック種別ごとに `_prepare_data()` でデータをパース。
       - デフォルトは JSON デコード。Protobuf 対応デバイスは各デバイスでオーバーライドし、バイナリ →XOR→Protobuf デコード等を実装。
       - パース後のデータは `EcoflowDataHolder`(`devices/data_holder.py`)の `params` 等に格納。
    3. **エンティティ生成**
       - 各デバイス(例: `DeltaPro`, `Delta2Max`)は `sensors()`/`switches()`/`numbers()`/`selects()` でエンティティリストを返す。
       - 各エンティティは `entities/__init__.py` の `EcoFlowDictEntity`/`BaseSensorEntity` などを継承。
    4. **Home Assistant 連携**
       - 各プラットフォームの `async_setup_entry()` で `device.sensors(client)` などを呼び出し、エンティティを登録。
       - エンティティは `CoordinatorEntity` として `coordinator`(デバイスの `EcoflowDeviceUpdateCoordinator`)のデータ更新を購読。
    5. **値の更新・反映**
       - データ更新時、`_handle_coordinator_update()` → `_updated(data)` で `params` から値を抽出し、エンティティの状態を更新。
       - `mqtt_key` で `params` 内の値を `jsonpath_ng` で抽出。
       - 値が変化した場合、Home Assistant の状態が自動で更新される。
  - **主要クラス・関数:**
    - `EcoflowMQTTClient`(MQTT 受信・publish)
    - `BaseDevice`(データパース・保持・エンティティ生成)
    - `EcoflowDataHolder`(データ保持・履歴管理)
    - `EcoFlowDictEntity`/`BaseSensorEntity` など(エンティティの値更新ロジック)
  - **備考:**
    - Protobuf 対応時は `_prepare_data()` のオーバーライドが必須。
    - データ構造やパース処理は DP3 対応時に再設計・拡張が必要な場合あり。

## 3. 参考情報・コミュニティ調査

- [ ] ioBroker.ecoflow-mqtt の Delta Pro3 対応状況調査
  - 例: 実装例やスキーマ、データマッピングの有無
  - **対応状況(2024 年 5 月時点):**
    - バージョン 1.3.0 で「Delta Pro 3 implementation」として公式に対応が追加。
    - [Changelog](https://github.com/foxthefox/ioBroker.ecoflow-mqtt#changelog)や[README](https://github.com/foxthefox/ioBroker.ecoflow-mqtt#implemented-devices--structure-with-datapoints)にも Delta Pro 3 の記載あり。
    - デバイス追加時に「Delta Pro 3」を選択可能。
  - **データマッピング・スキーマ:**
    - Protobuf ベースでのデータ受信・コマンド送信に対応。
    - コミュニティ(GitHub Issue #193, #270)で cmdId ごとのフィールド解析が進行中。
    - [AppShowHeartbeatReport.proto](https://github.com/tolwi/hassio-ecoflow-cloud/files/14321255/AppShowHeartbeatReport.proto.txt) など、主要な cmdId(1,2,3,4)の.proto ファイルが公開・流用可能。
    - Heartbeat や get_reply のデータは XOR デコード後に Protobuf でパース可能。
    - コマンド送信も Protobuf 形式で、cmdId=32 等で AC 出力 ON/OFF や設定変更が可能。
  - **実装例:**
    - [lib/ecoflow_data.js](https://github.com/foxthefox/ioBroker.ecoflow-mqtt/blob/main/lib/ecoflow_data.js)・[lib/parser.js](https://github.com/foxthefox/ioBroker.ecoflow-mqtt/blob/main/lib/parser.js)に DP3/Ultra 系のデータパース・マッピング実装あり。
    - データポイント(state 名・型・単位等)は adapter 起動時に自動生成され、HA の MQTT Discovery 経由で Home Assistant に連携。
  - **コミュニティ解析状況:**
    - [hassio-ecoflow-cloud Issue #193, #270](https://github.com/tolwi/hassio-ecoflow-cloud/issues/193)で DP3/Ultra のフィールド解析・サンプルデータ共有が活発。
    - XOR デコード・Protobuf パース・フィールド推測の手法が確立。
    - heartbeat(pdata)の XOR デコード方法や、主要なフィールド番号・意味も議論・共有されている。
  - **備考:**
    - ioBroker.ecoflow-mqtt の DP3 対応実装は、hassio-ecoflow-cloud やコミュニティの解析成果を積極的に取り込んでいる。
    - 公式 API/SDK は未公開のため、今後もサンプルデータ・フィールド推測の精度向上が期待される。
    - 実装・解析の進捗は GitHub Issue や Changelog を随時確認すること。
- [ ] GitHub issue #270 等のコミュニティ解析情報収集
  - 例: 実際のデータ例、フィールド推測、既知の課題
  - **参考情報源:**
    - [hassio-ecoflow-cloud Issue #270 (Delta Pro 3)](https://github.com/tolwi/hassio-ecoflow-cloud/issues/270)
    - [hassio-ecoflow-cloud Issue #193 (Delta Pro Ultra)](https://github.com/tolwi/hassio-ecoflow-cloud/issues/193)
    - [ioBroker.ecoflow-mqtt](https://github.com/foxthefox/ioBroker.ecoflow-mqtt)
  - **実際のデータ例:**
    - コミュニティユーザーが Node-RED や MQTT Explorer で取得した DP3 の MQTT メッセージ(HEX/BASE64 形式)が多数共有されている。
    - 例: `debug 4`(get_reply/heartbeat)や `debug 5/6`(set/set_reply)など、コマンド操作時・状態取得時の生データ。
    - サンプル: `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`
    - コマンド送信時の例: `CioKA8gBARAgGAIgASgBOANA/gFIEVADWAFww+7SigKAAROIAQG6AQNpb3M=`
  - **フィールド推測・進捗:**
    - foxthefox 氏らが、cmdId=32 等のメッセージに対し、Protobuf スキーマ(例: `message cmdFunc254_cmdId32_Report`)を作成し、フィールド番号ごとに値の意味を推測。
    - 例: `voltage68`(68): AC 出力電圧, `current69`(69): AC 出力電流, `
