# DP3 エンティティ定義実装タスク

## 1. 概要

Delta Pro 3のHome Assistant統合において、センサー、スイッチ、数値入力、セレクトの各エンティティを詳細に定義・実装する。
既存のDelta Pro/Delta 2 Maxの実装パターンを踏襲しつつ、DP3特有の機能・仕様に対応した包括的なエンティティセットを構築する。

## 2. 前提条件

### **依存コンポーネント**
- [ ] **delta_pro3.py実装**: `DP3_delta_pro3.py実装タスク.md` 完了
- [ ] **Protobufスキーマ**: DP3専用.protoファイル完成 (`DP3_Protobufスキーマ解析作成タスク.md` 参照)
- [ ] **既存構造理解**: Delta Pro/Delta 2 Maxエンティティ構造把握

### **技術要件**
- [ ] **Home Assistant Core**: Entity基底クラス対応
- [ ] **EcoFlow統合**: BaseSensorEntity等の活用
- [ ] **型安全性**: 完全な型ヒント対応

## 3. Phase 1: センサーエンティティ詳細実装

`ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md` の情報を元に、以下のセンサーエンティティを定義・拡充する。
特に `DisplayPropertyUpload` および `RuntimePropertyUpload` の `string`, `number`, `diagnostic` 型の情報を参照する。

### **3.1 バッテリー関連センサー (Battery Related Sensors)**

#### **メインバッテリー基本情報 (Main Battery Basic Info)**
```python
def _battery_sensors(self, client: EcoflowApiClient) -> list[BaseSensorEntity]:
    """バッテリー関連センサーエンティティ (主に `bms` および `cms` プレフィックスを持つ項目)
       ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md を参照。
    """
    return [
        # --- メインバッテリー (bms) ---
        # `bmsMaster.soc` は % (0-100), MQTTキー: `bmsMaster.soc` (ioBroker)
        BaseSensorEntity(client, self, "bmsBattSoc", "メインバッテリー残量", "%", device_class=SensorDeviceClass.BATTERY, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.soh` は % (0-100), MQTTキー: `bmsMaster.soh`
        BaseSensorEntity(client, self, "bmsBattSoh", "メインバッテリーSOH", "%", entity_category=EntityCategory.DIAGNOSTIC, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.designCap` は mAh, MQTTキー: `bmsMaster.designCap`
        BaseSensorEntity(client, self, "bmsDesignCap", "メインバッテリー設計容量", "mAh", entity_category=EntityCategory.DIAGNOSTIC),
        # `bmsMaster.fullCap` は mAh, MQTTキー: `bmsMaster.fullCap` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsFullCap", "メインバッテリー満充電容量", "mAh", entity_category=EntityCategory.DIAGNOSTIC),
        # `bmsMaster.remainCap` は mAh, MQTTキー: `bmsMaster.remainCap` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsRemainCap", "メインバッテリー残存容量", "mAh", entity_category=EntityCategory.DIAGNOSTIC),
        # `bmsMaster.cycles` は cycles, MQTTキー: `bmsMaster.cycles` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsCycles", "メインバッテリー充電サイクル", "cycles", entity_category=EntityCategory.DIAGNOSTIC, state_class=SensorStateClass.TOTAL_INCREASING, icon="mdi:battery-sync"),
        # `ems.dsgRemTime` は min, MQTTキー: `ems.dsgRemTime`
        BaseSensorEntity(client, self, "bmsDsgRemTime", "メインバッテリー放電残時間", UnitOfTime.MINUTES, device_class=SensorDeviceClass.DURATION, icon="mdi:timer-sand-empty"),
        # `ems.chgRemTime` は min, MQTTキー: `ems.chgRemTime`
        BaseSensorEntity(client, self, "bmsChgRemTime", "メインバッテリー充電残時間", UnitOfTime.MINUTES, device_class=SensorDeviceClass.DURATION, icon="mdi:timer-sand-complete"),
        # `bmsMaster.vol` は V (factor: 1000, i.e. raw value is mV), MQTTキー: `bmsMaster.vol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsBattVol", "メインバッテリー電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.minCellVol` は V (factor: 1000, i.e. raw value is mV), MQTTキー: `bmsMaster.minCellVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsMinCellVol", "メインバッテリー最小セル電圧", UnitOfElectricPotential.VOLT, entity_category=EntityCategory.DIAGNOSTIC, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.maxCellVol` は V (factor: 1000, i.e. raw value is mV), MQTTキー: `bmsMaster.maxCellVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsMaxCellVol", "メインバッテリー最大セル電圧", UnitOfElectricPotential.VOLT, entity_category=EntityCategory.DIAGNOSTIC, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.amp` は A (factor: 1000, i.e. raw value is mA), MQTTキー: `bmsMaster.amp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "bmsBattAmp", "メインバッテリー電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.maxCellTemp` は °C, MQTTキー: `bmsMaster.maxCellTemp`
        BaseSensorEntity(client, self, "bmsMaxCellTemp", "メインバッテリー温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT), # MaxTempを代表値とする
        # `bmsMaster.minCellTemp` は °C, MQTTキー: `bmsMaster.minCellTemp`
        BaseSensorEntity(client, self, "bmsMinCellTemp", "メインバッテリー最小セル温度", UnitOfTemperature.CELSIUS, entity_category=EntityCategory.DIAGNOSTIC, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.maxMosTemp` は °C, MQTTキー: `bmsMaster.maxMosTemp`
        BaseSensorEntity(client, self, "bmsMaxMosTemp", "メインバッテリー最大MOS温度", UnitOfTemperature.CELSIUS, entity_category=EntityCategory.DIAGNOSTIC, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsMaster.minMosTemp` は °C, MQTTキー: `bmsMaster.minMosTemp`
        BaseSensorEntity(client, self, "bmsMinMosTemp", "メインバッテリー最小MOS温度", UnitOfTemperature.CELSIUS, entity_category=EntityCategory.DIAGNOSTIC, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsChgDsgState` (0:not charging/discharging, 1:discharging, 2:charging) - `deltapro3.md` での対応MQTTキーと値の解釈を要確認
        BaseSensorEntity(client, self, "bmsChgDsgState", "メインバッテリー充放電状態", icon="mdi:battery-sync-outline", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "待機中", 1: "放電中", 2: "充電中"}}),
        # `bmsBalState` (RuntimePropertyUpload -> diagnostic) - `deltapro3.md` での対応MQTTキーと値の解釈を要確認
        BaseSensorEntity(client, self, "bmsBalState", "メインバッテリーセルバランス状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:scale-balance"),
        # `bmsAlmState` (RuntimePropertyUpload -> diagnostic) - `deltapro3.md` での対応MQTTキーと値の解釈を要確認 (例: bmsMaster.bmsFault)
        BaseSensorEntity(client, self, "bmsAlmState", "メインバッテリーアラーム状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:alert-outline"),
        # `bmsProState` (RuntimePropertyUpload -> diagnostic) - `deltapro3.md` での対応MQTTキーと値の解釈を要確認
        BaseSensorEntity(client, self, "bmsProState", "メインバッテリー保護状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:shield-half-full"),
        # `bmsFltState` (RuntimePropertyUpload -> diagnostic) - `deltapro3.md` での対応MQTTキーと値の解釈を要確認 (例: bmsMaster.bmsFault)
        BaseSensorEntity(client, self, "bmsFltState", "メインバッテリー故障状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:alert-octagon-outline"),

        # --- 総合バッテリー (cms) ---
        # `ems.lcdShowSoc` は % (0-100), MQTTキー: `ems.lcdShowSoc` (ioBroker)
        BaseSensorEntity(client, self, "cmsBattSoc", "総合バッテリー残量", "%", device_class=SensorDeviceClass.BATTERY, state_class=SensorStateClass.MEASUREMENT),
        # `ems.soh` は % (0-100), MQTTキー: `ems.soh`
        BaseSensorEntity(client, self, "cmsBattSoh", "総合バッテリーSOH", "%", entity_category=EntityCategory.DIAGNOSTIC, state_class=SensorStateClass.MEASUREMENT),
        # `ems.dsgRemTime` は min, MQTTキー: `ems.dsgRemTime` (メインバッテリーと同じキーだが、値は総合値を反映するはず)
        BaseSensorEntity(client, self, "cmsDsgRemTime", "総合放電残時間", UnitOfTime.MINUTES, device_class=SensorDeviceClass.DURATION, icon="mdi:timer-sand-empty"),
        # `ems.chgRemTime` は min, MQTTキー: `ems.chgRemTime` (メインバッテリーと同じキーだが、値は総合値を反映するはず)
        BaseSensorEntity(client, self, "cmsChgRemTime", "総合充電残時間", UnitOfTime.MINUTES, device_class=SensorDeviceClass.DURATION, icon="mdi:timer-sand-complete"),
        # `ems.vol` は V (factor: 1000, i.e. raw value is mV), MQTTキー: `ems.vol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "cmsBattVol", "総合バッテリー電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `ems.amp` は A (factor: 1000, i.e. raw value is mA), MQTTキー: `ems.amp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "cmsBattAmp", "総合バッテリー電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `ems.chgState` (0:not charging/discharging, 1:discharging, 2:charging), MQTTキー: `ems.chgState` - 値の解釈を要確認
        BaseSensorEntity(client, self, "cmsChgDsgState", "総合充放電状態", icon="mdi:battery-sync", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "待機中", 1: "放電中", 2: "充電中"}}),
        # `cmsBmsRunState` (0:off, 1:on) - `deltapro3.md` での対応MQTTキーと値の解釈を要確認 (例: ems.bmsIsCon ?)
        BaseSensorEntity(client, self, "cmsBmsRunState", "総合BMS実行状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:cog-transfer-outline"),
    ]
```

### **3.2 電力関連センサー (Power Related Sensors)**

#### **総合電力センサー (Overall Power Sensors)**
```python
def _power_sensors(self, client: EcoflowApiClient) -> list[BaseSensorEntity]:
    """全体および各系統の電力関連センサーエンティティ
       ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md を参照。
    """
    return [
        # `inv.inputWatts` は W, MQTTキー: `inv.inputWatts` (ioBroker)
        BaseSensorEntity(client, self, "powInSumW", "総入力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `inv.outputWatts` は W, MQTTキー: `inv.outputWatts` (ioBroker)
        BaseSensorEntity(client, self, "powOutSumW", "総出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
    ]
```

#### **AC電力センサー (AC Power Sensors)**
```python
def _ac_power_sensors(self, client: EcoflowApiClient) -> list[BaseSensorEntity]:
    """AC電力関連センサーエンティティ
       ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md を参照。
    """
    return [
        # --- AC入力 (主系統) ---
        # `inv.acInWatt` は W, MQTTキー: `inv.acInWatt` (ioBroker)
        BaseSensorEntity(client, self, "powGetAcIn", "AC入力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acInVol` は V (factor: 10), MQTTキー: `inv.acInVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoAcInVol", "AC入力電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acInAmp` は A (factor: 1000), MQTTキー: `inv.acInAmp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoAcInAmp", "AC入力電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acInFreq` は Hz, MQTTキー: `inv.acInFreq`
        BaseSensorEntity(client, self, "plugInInfoAcInFeq", "AC入力周波数", UnitOfFrequency.HERTZ, device_class=SensorDeviceClass.FREQUENCY, entity_category=EntityCategory.DIAGNOSTIC),
        # `inv.acInConnState` (0:disconnected, 1:connected), MQTTキー: `inv.acInConnState` - 値を確認
        BaseSensorEntity(client, self, "plugInInfoAcInFlag", "AC入力接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:power-plug-outline"),
        # `inv.acChgCfg` (0:not charging?, 1:charging?), MQTTキー: `inv.acChgCfg` - 値と意味を確認
        BaseSensorEntity(client, self, "plugInInfoAcChargerFlag", "AC充電器接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "非充電中", 1: "充電中"}}, icon="mdi:power-plug-battery-outline"), # `inv.acChgCfg`は設定値の可能性も
        # `pd.acautooutConfig.switch` (0:off, 1:on), MQTTキー: `pd.acautooutConfig.switch` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoAcIn", "AC入力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:electric-switch"), # スイッチエンティティとしても検討, ioBrokerでは 0/1

        # --- AC出力 ---
        # `inv.acOutWatt` は W, MQTTキー: `inv.acOutWatt`
        BaseSensorEntity(client, self, "powGetAc", "AC出力電力(総合)", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acOutFreq` は Hz, MQTTキー: `inv.acOutFreq`
        BaseSensorEntity(client, self, "acOutFreq", "AC出力周波数", UnitOfFrequency.HERTZ, device_class=SensorDeviceClass.FREQUENCY, entity_category=EntityCategory.DIAGNOSTIC),

        # --- 高電圧AC出力 (High-Voltage AC Output) ---
        # `inv.acOutHvWatt` は W, MQTTキー: `inv.acOutHvWatt`
        BaseSensorEntity(client, self, "powGetAcHvOut", "高電圧AC出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acOutHvL1Vol` は V (factor: 10), MQTTキー: `inv.acOutHvL1Vol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoL1Vol", "AC出力 L1 電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acOutHvL1Amp` は A (factor: 1000), MQTTキー: `inv.acOutHvL1Amp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoL1Amp", "AC出力 L1 電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acOutHvL2Vol` は V (factor: 10), MQTTキー: `inv.acOutHvL2Vol` (RuntimePropertyUpload), L2が存在する場合
        BaseSensorEntity(client, self, "plugInInfoL2Vol", "AC出力 L2 電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT, entity_registry_enabled_default=False), # L2はオプションのためデフォルト無効
        # `inv.acOutHvL2Amp` は A (factor: 1000), MQTTキー: `inv.acOutHvL2Amp` (RuntimePropertyUpload), L2が存在する場合
        BaseSensorEntity(client, self, "plugInInfoL2Amp", "AC出力 L2 電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT, entity_registry_enabled_default=False), # L2はオプションのためデフォルト無効
        # `pd.acautooutHvConfig.switch` (0:off, 1:on), MQTTキー: `pd.acautooutHvConfig.switch` - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoAcHvOut", "高電圧AC出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:electric-switch"), # スイッチエンティティとしても検討, ioBrokerでは 0/1

        # --- 低電圧AC出力 (Low-Voltage AC Output) ---
        # `inv.acOutLvWatt` は W, MQTTキー: `inv.acOutLvWatt`
        BaseSensorEntity(client, self, "powGetAcLvOut", "低電圧AC出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `inv.acOutLvTt30Watt` は W, MQTTキー: `inv.acOutLvTt30Watt`, TT-30ポートがある場合
        BaseSensorEntity(client, self, "powGetAcLvTt30Out", "低電圧AC TT-30出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, entity_registry_enabled_default=False), # TT-30はオプションのためデフォルト無効
        # `pd.acautooutLvConfig.switch` (0:off, 1:on), MQTTキー: `pd.acautooutLvConfig.switch` - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoAcLvOut", "低電圧AC出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:electric-switch"), # スイッチエンティティとしても検討, ioBrokerでは 0/1

        # --- その他AC関連 ---
        # `inv.acOutMode` (0: LV, 1: HV), MQTTキー: `inv.acOutMode`
        BaseSensorEntity(client, self, "llcHvLvFlag", "高電圧/低電圧AC識別子", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "低電圧", 1: "高電圧"}}, icon="mdi:information-outline"),
        # `inv.cfgAcWorkMode` (e.g., 1 for single phase, 2 for split phase), MQTTキー: `inv.cfgAcWorkMode` (RuntimePropertyUpload -> diagnostic)
        BaseSensorEntity(client, self, "acPhaseType", "AC相タイプ", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:sine-wave"),
        # `inv.cfgAcOutStd` (e.g., 1 for US, 2 for EU), MQTTキー: `inv.cfgAcOutStd` (RuntimePropertyUpload -> diagnostic)
        BaseSensorEntity(client, self, "plugInInfoAcOutType", "AC出力タイプ", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:power-socket-us"), # 例としてUS
    ]
```

### **3.3 USB/Type-C電力センサー (USB/Type-C Power Sensors)**

#### **USB/Type-C出力センサー**
```python
def _usb_power_sensors(self, client: EcoflowApiClient) -> list[BaseSensorEntity]:
    """USB/Type-C電力センサーエンティティ
       ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md を参照。
    """
    return [
        # `pd.qcUsb1Watts` は W, MQTTキー: `pd.qcUsb1Watts` (ioBroker)
        BaseSensorEntity(client, self, "powGetQcusb1", "USB-A 1 出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `pd.qcUsb2Watts` は W, MQTTキー: `pd.qcUsb2Watts` (ioBroker)
        BaseSensorEntity(client, self, "powGetQcusb2", "USB-A 2 出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `pd.typec1Watts` は W, MQTTキー: `pd.typec1Watts` (ioBroker)
        BaseSensorEntity(client, self, "powGetTypec1", "USB-C 1 出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `pd.typec2Watts` は W, MQTTキー: `pd.typec2Watts` (ioBroker)
        BaseSensorEntity(client, self, "powGetTypec2", "USB-C 2 出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),

        # --- スイッチ状態 (diagnosticから) ---
        # `pd.qcUsb1State` (0:off, 1:on), MQTTキー: `pd.qcUsb1State` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoQcusb1", "USB-A 1 スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:usb-port"), # スイッチエンティティとしても検討, ioBrokerでは 0/1
        # `pd.qcUsb2State` (0:off, 1:on), MQTTキー: `pd.qcUsb2State` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoQcusb2", "USB-A 2 スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:usb-port"), # スイッチエンティティとしても検討, ioBrokerでは 0/1
        # `pd.typec1State` (0:off, 1:on), MQTTキー: `pd.typec1State` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoTypec1", "USB-C 1 スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:usb-port"), # スイッチエンティティとしても検討, ioBrokerでは 0/1
        # `pd.typec2State` (0:off, 1:on), MQTTキー: `pd.typec2State` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfoTypec2", "USB-C 2 スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:usb-port"), # スイッチエンティティとしても検討, ioBrokerでは 0/1
    ]
```

### **3.4 DC (12V/24V/PV/その他) 電力センサー (DC Power Sensors)**

```python
def _dc_power_sensors(self, client: EcoflowApiClient) -> list[BaseSensorEntity]:
    """DC系統 (12V, 24V, PV, Power I/O, Extra Battery) のセンサーエンティティ
       ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md を参照。
    """
    return [
        # --- 12V DC出力 ---
        # `pd.carOutWatts` は W, MQTTキー: `pd.carOutWatts` (ioBroker)
        BaseSensorEntity(client, self, "powGet_12v", "12V DC出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `pd.carOutVol` は V (factor: 1000), MQTTキー: `pd.carOutVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_12vVol", "12V DC出力電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `pd.carOutAmp` は A (factor: 1000), MQTTキー: `pd.carOutAmp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_12vAmp", "12V DC出力電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `pd.carState` (0:off, 1:on), MQTTキー: `pd.carState` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfo_12v", "12V DC出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:car-battery"), # スイッチエンティティとしても検討, ioBrokerでは 0/1

        # --- 24V DC出力 ---
        # `pd.dc24vOutWatts` は W, MQTTキー: `pd.dc24vOutWatts` (ioBroker)
        BaseSensorEntity(client, self, "powGet_24v", "24V DC出力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT),
        # `pd.dc24vOutVol` は V (factor: 1000), MQTTキー: `pd.dc24vOutVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_24vVol", "24V DC出力電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `pd.dc24vOutAmp` は A (factor: 1000), MQTTキー: `pd.dc24vOutAmp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_24vAmp", "24V DC出力電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `pd.dc24vState` (0:off, 1:on), MQTTキー: `pd.dc24vState` (ioBroker) - 値は0/1か0/2か確認。既存は0/2。
        BaseSensorEntity(client, self, "flowInfo_24v", "24V DC出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:truck-check-outline"), # スイッチエンティティとしても検討, ioBrokerでは 0/1

        # --- PV入力 (ソーラー) ---
        # 高電圧PV
        # `mppt.inPvHvWatt` は W, MQTTキー: `mppt.inPvHvWatt` (ioBroker)
        BaseSensorEntity(client, self, "powGetPvH", "高電圧PV入力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, icon="mdi:solar-power-variant-outline"),
        # `mppt.inPvHvVol` は V (factor: 10), MQTTキー: `mppt.inPvHvVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoPvHVol", "高電圧PV入力電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `mppt.inPvHvAmp` は A (factor: 1000), MQTTキー: `mppt.inPvHvAmp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoPvHAmp", "高電圧PV入力電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `mppt.pvHvConnState` (0:disconnected, 1:connected), MQTTキー: `mppt.pvHvConnState`
        BaseSensorEntity(client, self, "plugInInfoPvHFlag", "高電圧PV接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:solar-panel"),
        # `mppt.pvHvChargeState` (0:not charging, 1:charging), MQTTキー: `mppt.pvHvChargeState`
        BaseSensorEntity(client, self, "plugInInfoPvHChargerFlag", "高電圧PV充電器接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "非充電中", 1: "充電中"}}, icon="mdi:power-plug-outline"),
        # `mppt.cfgPvHvChargeType` (1:car, 2:solar, 3:dc), MQTTキー: `mppt.cfgPvHvChargeType`
        BaseSensorEntity(client, self, "plugInInfoPvHType", "高電圧PV充電モード", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {1: "シガーソケット充電", 2: "ソーラー充電", 3: "DC充電"}}, icon="mdi:car-electric-outline"),
        # `mppt.pvHvSwitch` (0:off, 1:on), MQTTキー: `mppt.pvHvSwitch`
        BaseSensorEntity(client, self, "flowInfoPvH", "高電圧PVスイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:electric-switch"), # スイッチエンティティとしても検討, ioBrokerでは 0/1, 既存は0/2だったのを修正

        # 低電圧PV
        # `mppt.inPvLvWatt` は W, MQTTキー: `mppt.inPvLvWatt` (ioBroker)
        BaseSensorEntity(client, self, "powGetPvL", "低電圧PV入力電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, icon="mdi:solar-power"),
        # `mppt.inPvLvVol` は V (factor: 10), MQTTキー: `mppt.inPvLvVol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoPvLVol", "低電圧PV入力電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `mppt.inPvLvAmp` は A (factor: 1000), MQTTキー: `mppt.inPvLvAmp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfoPvLAmp", "低電圧PV入力電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `mppt.pvLvConnState` (0:disconnected, 1:connected), MQTTキー: `mppt.pvLvConnState`
        BaseSensorEntity(client, self, "plugInInfoPvLFlag", "低電圧PV接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:solar-panel-large"),
        # `mppt.pvLvChargeState` (0:not charging, 1:charging), MQTTキー: `mppt.pvLvChargeState`
        # `plugInInfoPvLChargerFlag` (0:disconnected, 1:connected)
        BaseSensorEntity(client, self, "plugInInfoPvLChargerFlag", "低電圧PV充電器接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:power-plug-outline"),
        # `plugInInfoPvLType` (0:disconnected, 1:connected) -> DP3.mdの値はこれだが、おそらくH同様モードのはず。要確認
        BaseSensorEntity(client, self, "plugInInfoPvLType", "低電圧PV充電モード", entity_category=EntityCategory.DIAGNOSTIC,
             attr={"value_mapping": {0:"未接続/不明", 1:"接続/タイプ1?"}}, icon="mdi:help-circle-outline"), # 要実機確認
        # `flowInfoPvL` (0:off, 1:on)
        BaseSensorEntity(client, self, "flowInfoPvL", "低電圧PVスイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:electric-switch"), # スイッチエンティティとしても検討, ioBrokerでは 0/1, 既存は0/2だったのを修正

        # --- Power In/Out ポート (5p8) ---
        # `mppt.inChgPowerIoWatt` は W, MQTTキー: `mppt.inChgPowerIoWatt` (ioBroker)
        BaseSensorEntity(client, self, "powGet_5p8", "Power I/O ポート電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, icon="mdi:power-plug-outline"),
        # `mppt.powerIoFreq` は Hz, MQTTキー: `mppt.powerIoFreq` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_5p8Freq", "Power I/O ポート周波数", UnitOfFrequency.HERTZ, device_class=SensorDeviceClass.FREQUENCY, entity_category=EntityCategory.DIAGNOSTIC),
        # `mppt.powerIoConnState` (0:disconnected, 1:connected), MQTTキー: `mppt.powerIoConnState`
        BaseSensorEntity(client, self, "plugInInfo_5p8Flag", "Power I/O ポート接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:lan-connect"),
        # `mppt.powerIoChargeState` (0:not charging?, 1:charging?), MQTTキー: `mppt.powerIoChargeState` - 確認
        BaseSensorEntity(client, self, "plugInInfo_5p8ChargerFlag", "Power I/O ポート充電器状態", entity_category=EntityCategory.DIAGNOSTIC,
             attr={"value_mapping": {0: "非動作中", 1: "動作中"}}, icon="mdi:lan-pending"), # 値はおそらく0/1
        # `mppt.powerIoWorkState` (0:OK?), MQTTキー: `mppt.powerIoWorkState` - 確認
        BaseSensorEntity(client, self, "plugInInfo_5p8RunState", "Power I/O ポート実行状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:cogs"),
        # `mppt.cfgPowerIoStd` (string - 例: "EPS", "Charge"?), MQTTキー: `mppt.cfgPowerIoStd` - 値の具体的な意味を確認
        BaseSensorEntity(client, self, "plugInInfo_5p8DsgChg", "Power I/O ポート充放電タイプ", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:swap-horizontal-bold"),
        # `mppt.powerIoInSwitch` (0:off, 1:on), MQTTキー: `mppt.powerIoInSwitch`
        BaseSensorEntity(client, self, "flowInfo_5p8In", "Power I/O ポート入力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:arrow-left-bold-box-outline"), # スイッチエンティティとしても検討, ioBrokerでは 0/1, 既存は0/2だったのを修正
        # `mppt.powerIoOutSwitch` (0:off, 1:on), MQTTキー: `mppt.powerIoOutSwitch`
        BaseSensorEntity(client, self, "flowInfo_5p8Out", "Power I/O ポート出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:arrow-right-bold-box-outline"), # スイッチエンティティとしても検討, ioBrokerでは 0/1, 既存は0/2だったのを修正

        # --- 拡張バッテリーポート1 (4p8_1) ---
        # `bmsSlave1.sysPower` は W, MQTTキー: `bmsSlave1.sysPower` (ioBroker) (値は負になることもありそう)
        BaseSensorEntity(client, self, "powGet_4p8_1", "拡張バッテリー1 電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, icon="mdi:battery-plus-variant"),
        # `bmsSlave1.vol` は V (factor: 1000), MQTTキー: `bmsSlave1.vol` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_4p8_1Vol", "拡張バッテリー1 電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `bmsSlave1.amp` は A (factor: 1000), MQTTキー: `bmsSlave1.amp` (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_4p8_1Amp", "拡張バッテリー1 電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `bmsSlave1.connState` (0:disconnected, 1:connected), MQTTキー: `bmsSlave1.connState`
        BaseSensorEntity(client, self, "plugInInfo_4p8_1InFlag", "拡張バッテリー1 接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:battery-unknown"),
        # `bmsSlave1.chargeState` (0:not charging?, 1:charging?), MQTTキー: `bmsSlave1.chargeState` - 確認
        BaseSensorEntity(client, self, "plugInInfo_4p8_1ChargerFlag", "拡張バッテリー1 充電器状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "非動作中", 1: "動作中"}}, icon="mdi:battery-charging-outline"), # 値はおそらく0/1
        # `bmsSlave1.workState` (0:OK?), MQTTキー: `bmsSlave1.workState` - 確認
        BaseSensorEntity(client, self, "plugInInfo_4p8_1RunState", "拡張バッテリー1 実行状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-heart-variant"),
        # `bmsSlave1.cfgChgDsgType` (0:reserved,1:charging/discharging,2:charging only,3:discharging only), MQTTキー: `bmsSlave1.cfgChgDsgType`
        BaseSensorEntity(client, self, "plugInInfo_4p8_1DsgChgType", "拡張バッテリー1 充放電タイプ", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0:"予約", 1:"充放電", 2:"充電のみ", 3:"放電のみ"}}, icon="mdi:battery-sync-outline"),
        # `bmsSlave1.inSwitch` (0:off, 1:on), MQTTキー: `bmsSlave1.inSwitch`
        BaseSensorEntity(client, self, "flowInfo_4p8_1In", "拡張バッテリー1 入力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:arrow-left-bold-box-outline"), # ioBrokerでは 0/1, 既存は0/2だったのを修正
        # `bmsSlave1.outSwitch` (0:off, 1:on), MQTTキー: `bmsSlave1.outSwitch`
        BaseSensorEntity(client, self, "flowInfo_4p8_1Out", "拡張バッテリー1 出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:arrow-right-bold-box-outline"), # ioBrokerでは 0/1, 既存は0/2だったのを修正

        # --- 拡張バッテリーポート2 (4p8_2) ---
        # `powGet_4p8_2` は W (0-4000)
        BaseSensorEntity(client, self, "powGet_4p8_2", "拡張バッテリー2 電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, icon="mdi:battery-plus-variant"),
        # `plugInInfo_4p8_2Vol` は V (0-240) (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2Vol", "拡張バッテリー2 電圧", UnitOfElectricPotential.VOLT, device_class=SensorDeviceClass.VOLTAGE, state_class=SensorStateClass.MEASUREMENT),
        # `plugInInfo_4p8_2Amp` は A (0-30) (RuntimePropertyUpload)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2Amp", "拡張バッテリー2 電流", UnitOfElectricCurrent.AMPERE, device_class=SensorDeviceClass.CURRENT, state_class=SensorStateClass.MEASUREMENT),
        # `plugInInfo_4p8_2InFlag` (0:disconnected, 1:connected)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2InFlag", "拡張バッテリー2 接続状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "未接続", 1: "接続済み"}}, icon="mdi:battery-unknown"),
        # `plugInInfo_4p8_2ChargerFlag` (0:not charging?, 1:charging?)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2ChargerFlag", "拡張バッテリー2 充電器状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "非動作中", 1: "動作中"}}, icon="mdi:battery-charging-outline"),
        # `plugInInfo_4p8_2RunState` (0:OK?)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2RunState", "拡張バッテリー2 実行状態", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-heart-variant"),
        # `plugInInfo_4p8_2DsgChgType` (0:reserved,1:charging/discharging,2:charging only,3:discharging only)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2DsgChgType", "拡張バッテリー2 充放電タイプ", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0:"予約", 1:"充放電", 2:"充電のみ", 3:"放電のみ"}}, icon="mdi:battery-sync-outline"),
        # `flowInfo_4p8_2In` (0:off, 2:on)
        BaseSensorEntity(client, self, "flowInfo_4p8_2In", "拡張バッテリー2 入力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:arrow-left-bold-box-outline"), # ioBrokerでは 0/1, 既存は0/2だったのを修正
        # `flowInfo_4p8_2Out` (0:off, 2:on)
        BaseSensorEntity(client, self, "flowInfo_4p8_2Out", "拡張バッテリー2 出力スイッチ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "オフ", 1: "オン"}}, icon="mdi:arrow-right-bold-box-outline"), # ioBrokerでは 0/1, 既存は0/2だったのを修正

        # --- その他内部電力・温度センサー (主にRuntimePropertyUploadから) ---
        # `inv.llcWat` は W, MQTTキー: `inv.llcWat` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "powGetLlc", "LLC電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `bmsMaster.sysPower` は W (メインBMSの消費電力か？), MQTTキー: `bmsMaster.sysPower` (ioBroker, RuntimePropertyUpload) - 要確認
        BaseSensorEntity(client, self, "powGetBms", "BMS電力", UnitOfPower.WATT, device_class=SensorDeviceClass.POWER, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `inv.dcTemp` は °C, MQTTキー: `inv.dcTemp` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "tempPcsDc", "PCS DC温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `inv.acTemp` は °C, MQTTキー: `inv.acTemp` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "tempPcsAc", "PCS AC温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `mppt.pvHvInnerTemp` は °C, MQTTキー: `mppt.pvHvInnerTemp` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "tempPvH", "高電圧PV温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `mppt.pvLvInnerTemp` は °C, MQTTキー: `mppt.pvLvInnerTemp` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "tempPvL", "低電圧PV温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `pd.adsTemp` は °C, MQTTキー: `pd.adsTemp` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "adsNtcTemp", "ADS NTC温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `inv.InvTemp2` (仮) - `deltapro3.md` に直接対応するキーが見当たらない。要確認。
        BaseSensorEntity(client, self, "invNtcTemp2", "インバーターNTC2温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `inv.InvTemp3` (仮) - `deltapro3.md` に直接対応するキーが見当たらない。要確認。
        BaseSensorEntity(client, self, "invNtcTemp3", "インバーターNTC3温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
        # `inv.llcTemp` は °C, MQTTキー: `inv.llcTemp` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "llcNtcTemp", "LLC NTC温度", UnitOfTemperature.CELSIUS, device_class=SensorDeviceClass.TEMPERATURE, state_class=SensorStateClass.MEASUREMENT, entity_category=EntityCategory.DIAGNOSTIC),
    ]
```

### **3.5 デバイス状態・情報センサー (Device Status & Information Sensors)**

```python
def _status_info_sensors(self, client: EcoflowApiClient) -> list[BaseSensorEntity]:
    """デバイスの全体的な状態、エラーコード、ファームウェアバージョン等のセンサーエンティティ
       ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md を参照。
    """
    return [
        # --- エラーコード ---
        # `pd.errCode` (string), MQTTキー: `pd.errCode` (ioBroker) - デバイス全体の主要エラーコード
        BaseSensorEntity(client, self, "errcode", "エラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:alert-circle-outline"),
        # `bmsMaster.bmsFault` (number), MQTTキー: `bmsMaster.bmsFault` (ioBroker) - BMSのエラー状態 (ビットフィールドの可能性も)
        BaseSensorEntity(client, self, "bmsErrCode", "BMSエラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-alert-variant-outline"),
        # `pd.errCode` (string), MQTTキー: `pd.errCode` (ioBroker) - PDモジュールのエラーコード (errcodeと同じ可能性が高いが個別にも定義)
        BaseSensorEntity(client, self, "pdErrCode", "PDエラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:power-settings"),
        # `inv.llcFault` (number), MQTTキー: `inv.llcFault` (ioBroker) - LLCのエラー状態 (ビットフィールドの可能性も)
        BaseSensorEntity(client, self, "llcErrCode", "LLCエラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:chip"),
        # `mppt.fault` (number), MQTTキー: `mppt.fault` (ioBroker) - MPPTのエラー状態 (ビットフィールドの可能性も)
        BaseSensorEntity(client, self, "mpptErrCode", "MPPTエラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:solar-panel"),
        # `inv.fault` (number), MQTTキー: `inv.fault` (ioBroker) - インバーター全体のエラー状態 (ビットフィールドの可能性も)
        BaseSensorEntity(client, self, "llcInvErrCode", "LLCインバーターエラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:grid"), # inv.fault を代表とする
        # `mppt.powerIoFault` (number), MQTTキー: `mppt.powerIoFault` (ioBroker) - Power I/Oのエラー状態
        BaseSensorEntity(client, self, "plugInInfo_5p8ErrCode", "Power I/O ポートエラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:alert-box-outline"),
        # `bmsSlave1.bmsFault` (number), MQTTキー: `bmsSlave1.bmsFault` (ioBroker) - 拡張バッテリー1のBMSエラー状態
        BaseSensorEntity(client, self, "plugInInfo_4p8_1ErrCode", "拡張バッテリー1 エラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-alert"),
        # `bmsSlave2.bmsFault` (number), MQTTキー: `bmsSlave2.bmsFault` (ioBroker) - 拡張バッテリー2のBMSエラー状態
        BaseSensorEntity(client, self, "plugInInfo_4p8_2ErrCode", "拡張バッテリー2 エラーコード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-alert"),

        # --- タイムゾーン情報 ---
        # `pd.utcTimezoneId` (string), MQTTキー: `pd.utcTimezoneId` (ioBroker)
        BaseSensorEntity(client, self, "utcTimezoneId", "タイムゾーンID", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:map-clock-outline"),
        # `pd.utcOffset` (number, min, e.g. -420 for GMT-7), MQTTキー: `pd.utcOffset` (ioBroker)
        BaseSensorEntity(client, self, "utcTimezone", "タイムゾーンオフセット", "min", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:map-clock"), # 単位は分

        # --- ファームウェアバージョン ---
        # `pd.swVersion` (string), MQTTキー: `pd.swVersion` (ioBroker, RuntimePropertyUpload) (hwVersionも存在)
        BaseSensorEntity(client, self, "pdFirmVer", "PDファームウェアバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:chip"),
        # `iot.swVersion` (string), MQTTキー: `iot.swVersion` (ioBroker, RuntimePropertyUpload) (pd.iotHwVersionも存在)
        BaseSensorEntity(client, self, "iotFirmVer", "IoTファームウェアバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:wifi-cog"),
        # `mppt.swVersion` (string), MQTTキー: `mppt.swVersion` (ioBroker, RuntimePropertyUpload) (hwVersionも存在)
        BaseSensorEntity(client, self, "mpptFirmVer", "MPPTファームウェアバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:solar-panel"),
        # `inv.llcSwVersion` (string), MQTTキー: `inv.llcSwVersion` (ioBroker, RuntimePropertyUpload) (llcHwVersionも存在)
        BaseSensorEntity(client, self, "llcFirmVer", "LLCファームウェアバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:chip"),
        # `inv.invSwVersion` (string), MQTTキー: `inv.invSwVersion` (ioBroker, RuntimePropertyUpload) (invHwVersionも存在)
        BaseSensorEntity(client, self, "llcInvFirmVer", "LLCインバーターファームウェアバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:grid"),
        # `bmsMaster.swVersion` (string), MQTTキー: `bmsMaster.swVersion` (ioBroker, RuntimePropertyUpload) (hwVersionも存在)
        BaseSensorEntity(client, self, "bmsFirmVer", "BMSファームウェアバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-cog-outline"),
        # `bmsSlave1.sn` (string), MQTTキー: `bmsSlave1.sn` (ioBroker)
        BaseSensorEntity(client, self, "plugInInfo_4p8_1Sn", "拡張バッテリー1 SN", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:barcode-scan"),
        # `bmsSlave1.swVersion` (string), MQTTキー: `bmsSlave1.swVersion` (ioBroker) (hwVersionも存在)
        BaseSensorEntity(client, self, "plugInInfo_4p8_1FirmVer", "拡張バッテリー1 FWバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-sync"),
        # `bmsSlave2.sn` (string), MQTTキー: `bmsSlave2.sn` (ioBroker)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2Sn", "拡張バッテリー2 SN", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:barcode-scan"),
        # `bmsSlave2.swVersion` (string), MQTTキー: `bmsSlave2.swVersion` (ioBroker) (hwVersionも存在)
        BaseSensorEntity(client, self, "plugInInfo_4p8_2FirmVer", "拡張バッテリー2 FWバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:battery-sync"),
        # `mppt.powerIoSn` (string), MQTTキー: `mppt.powerIoSn` (ioBroker)
        BaseSensorEntity(client, self, "plugInInfo_5p8Sn", "Power I/O ポートデバイスSN", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:barcode-scan"),
        # `mppt.powerIoSwVersion` (string), MQTTキー: `mppt.powerIoSwVersion` (ioBroker) (powerIoHwVersionも存在)
        BaseSensorEntity(client, self, "plugInInfo_5p8FirmVer", "Power I/O ポートデバイスFWバージョン", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:lan"),

        # --- ファン状態 ---
        # `inv.fanLevel` (number, 0-100% or level), MQTTキー: `inv.fanLevel` (ioBroker)
        BaseSensorEntity(client, self, "pcsFanLevel", "PCSファンレベル", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:fan"), # 数値 (レベルまたは%) と思われる
        # `mppt.fanLevel` (number, rpm or level), MQTTキー: `mppt.fanLevel` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "mpptFanspeed", "MPPTファン速度", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:fan"), # 数値 (RPMまたはレベル) と思われる
        # `inv.fanFault` (0:OK, 1:error), MQTTキー: `inv.fanFault` (ioBroker)
        BaseSensorEntity(client, self, "pcsFanErrFlag", "PCSファンエラーフラグ", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "正常", 1: "エラー"}}, icon="mdi:fan-alert"),

        # --- その他デバイス状態 ---
        # `pd.bpMasterSwitch` (0:Off, 1:On), MQTTキー: `pd.bpMasterSwitch` (ioBroker). 「バックアップリザーブ有効/無効」がより適切か。
        BaseSensorEntity(client, self, "energyBackupState", "バックアップリザーブ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "無効", 1: "有効"}}, icon="mdi:shield-check-outline"), # 0:OK? の意味を確認 -> 0:無効, 1:有効 に修正
        # `pd.acPowerOffMemMode` (0:OFF, 1:ON), MQTTキー: `pd.acPowerOffMemMode` (ioBroker)
        BaseSensorEntity(client, self, "outputPowerOffMemory", "出力電源オフメモリ", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "無効", 1: "有効"}}, icon="mdi:memory"),
        # `iot.iotSleepMode` (0: Never Sleep?, 1: Sleep after X min?), MQTTキー: `iot.iotSleepMode` (ioBroker) - 要確認。
        # `pd.standbyTime` (0:never, 30, 60.. min) はタイムアウト設定であり、現在のスリープ状態ではない。
        BaseSensorEntity(client, self, "devSleepState", "スリープ状態", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "アクティブ", 1: "スリープ中"}}, icon="mdi:power-sleep"), # MQTTキーと値の解釈を要確認
        # `inv.workMode` (number), MQTTキー: `inv.workMode` (ioBroker, RuntimePropertyUpload) - 具体的な値のマッピングを要調査
        BaseSensorEntity(client, self, "pcsWorkMode", "PCS動作モード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:state-machine"),
        # `inv.cfgDcChgPrio` (number), MQTTキー: `inv.cfgDcChgPrio` (ioBroker, RuntimePropertyUpload) - 「DC充電優先度」などがより適切か？
        BaseSensorEntity(client, self, "pdToInvDsgMode", "PDからインバーターへの放電モード", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:directions-fork"), # 名称とMQTTキーの整合性確認
        # `pd.chgTimeTaskSetNum` (number 0-60), MQTTキー: `pd.chgTimeTaskSetNum` (ioBroker)
        BaseSensorEntity(client, self, "timeTaskChangeCnt", "タイマータスク変更回数", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:history"),
        # `pd.chgTimeTaskConflict` (0:no conflict, 1:conflict), MQTTキー: `pd.chgTimeTaskConflict` (ioBroker)
        BaseSensorEntity(client, self, "timeTaskConflictFlag", "タイマータスク競合フラグ", entity_category=EntityCategory.DIAGNOSTIC,
            attr={"value_mapping": {0: "競合なし", 1: "競合あり"}}, icon="mdi:alarm-light-outline"),
        # `iot.dispFullUpItv` (ms), MQTTキー: `iot.dispFullUpItv` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "displayPropertyFullUploadPeriod", "表示プロパティ完全アップロード周期", "ms", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:timer-sync-outline"), # 単位を s から ms に修正
        # `iot.dispIncUpItv` (ms), MQTTキー: `iot.dispIncUpItv` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "displayPropertyIncrementalUploadPeriod", "表示プロパティ増分アップロード周期", "ms", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:timer-sync-outline"), # 単位を s から ms に修正
        # `iot.dataFullUpItv` (ms), MQTTキー: `iot.dataFullUpItv` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "runtimePropertyFullUploadPeriod", "ランタイムプロパティ完全アップロード周期", "ms", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:timer-cog-outline"), # 単位を s から ms に修正
        # `iot.dataIncUpItv` (ms), MQTTキー: `iot.dataIncUpItv` (ioBroker, RuntimePropertyUpload)
        BaseSensorEntity(client, self, "runtimePropertyIncrementalUploadPeriod", "ランタイムプロパティ増分アップロード周期", "ms", entity_category=EntityCategory.DIAGNOSTIC, icon="mdi:timer-cog-outline"), # 単位を s から ms に修正
    ]
```

## 4. Phase 2: スイッチエンティティ詳細実装

### **4.1 出力制御スイッチ**

#### **AC/DC出力スイッチ**
```python
def _output_switches(self, client: EcoflowApiClient) -> list[BaseSwitchEntity]:
    """出力制御スイッチエンティティ"""
    return [
        # AC出力制御
        BaseSwitchEntity(
            client, self, "invCfgAcEnabled", AC_ENABLED,
            lambda value, params: self._create_ac_output_command(value),
            attr={
                "output_type": "ac",
                "max_power": "invMaxOutputWatts",
                "xboost_available": True
            }
        ),

        # X-Boost制御
        BaseSwitchEntity(
            client, self, "invCfgAcXboost", XBOOST_ENABLED,
            lambda value, params: self._create_xboost_command(value),
            attr={
                "feature_type": "power_boost",
                "requires_ac_enabled": True,
                "max_boost_power": 3600
            }
        ),

        # DC出力制御
        BaseSwitchEntity(
            client, self, "mpptCarState", DC_ENABLED,
            lambda value, params: self._create_dc_output_command(value),
            attr={
                "output_type": "dc",
                "connector_types": ["cigarette_lighter", "anderson"]
            }
        ),
    ]
```

## 5. Phase 3: 数値入力エンティティ詳細実装

### **5.1 充電制御ナンバー**

#### **充電設定ナンバー**
```python
def _charging_numbers(self, client: EcoflowApiClient) -> list[BaseNumberEntity]:
    """充電制御ナンバーエンティティ"""
    return [
        # 充電上限
        BaseNumberEntity(
            client, self, "bmsMaxChargeSoc", "Max Charge Level", "%",
            50, 100, 1,
            lambda value, params: self._create_charge_limit_command(int(value)),
            attr={
                "setting_type": "charge_limit",
                "safety_range": "50-100",
                "default_value": 80
            }
        ),

        # 放電下限
        BaseNumberEntity(
            client, self, "bmsMinDischargeSoc", "Min Discharge Level", "%",
            0, 30, 1,
            lambda value, params: self._create_discharge_limit_command(int(value)),
            attr={
                "setting_type": "discharge_limit",
                "safety_range": "0-30",
                "default_value": 10
            }
        ),

        # AC充電電力
        BaseNumberEntity(
            client, self, "invCfgSlowChgWatts", "AC Charging Power", "W",
            400, 2900, 100,
            lambda value, params: self._create_ac_charge_power_command(int(value)),
            attr={
                "setting_type": "charge_power",
                "power_type": "ac_input",
                "step_size": 100
            }
        ),
    ]
```

## 6. Phase 4: セレクトエンティティ詳細実装

### **6.1 タイムアウト設定セレクト**

#### **タイムアウト制御セレクト**
```python
def _timeout_selects(self, client: EcoflowApiClient) -> list[BaseSelectEntity]:
    """タイムアウト制御セレクトエンティティ"""
    return [
        # スクリーンタイムアウト
        BaseSelectEntity(
            client, self, "pdLcdOffSec", "Screen Timeout",
            ["Never", "10sec", "30sec", "1min", "5min", "30min"],
            lambda value, params: self._create_screen_timeout_command(value),
            attr={
                "setting_type": "display",
                "feature": "auto_off",
                "power_saving": True
            }
        ),

        # ユニットタイムアウト
        BaseSelectEntity(
            client, self, "pdStandbyMode", "Unit Timeout",
            ["Never", "30min", "1hr", "2hr", "6hr", "12hr"],
            lambda value, params: self._create_unit_timeout_command(value),
            attr={
                "setting_type": "power_management",
                "feature": "standby_mode",
                "power_saving": True
            }
        ),
    ]
```

## 7. 成果物・次ステップ

### **7.1 期待される成果物**
- [ ] **包括的センサーエンティティ**: 50+個のセンサー
- [ ] **完全なスイッチエンティティ**: 主要制御機能100%カバー
- [ ] **詳細ナンバーエンティティ**: 充電・バックアップ制御
- [ ] **豊富なセレクトエンティティ**: タイムアウト・モード設定
- [ ] **属性情報充実**: 各エンティティの詳細メタデータ

### **7.2 品質基準**
- [ ] **機能網羅性**: DP3主要機能95%以上カバー
- [ ] **型安全性**: 完全な型ヒント対応
- [ ] **属性充実**: 各エンティティに適切なメタデータ
- [ ] **命名一貫性**: 既存デバイスとの統一性

### **7.3 次ステップへの引き継ぎ**
- [ ] **コマンド送信実装**: 詳細コマンド処理
- [ ] **HA統合テスト**: 実際のHA環境でのテスト
- [ ] **実機テスト**: 実機での動作検証

---

## 備考

- **既存パターン踏襲**: Delta Pro/Delta 2 Maxとの一貫性
- **DP3特有機能**: 新機能への対応
- **属性充実**: 各エンティティの詳細情報
- **拡張性**: 将来の機能追加に対応

このタスクの完了により、DP3のHome Assistant統合エンティティが完成します。