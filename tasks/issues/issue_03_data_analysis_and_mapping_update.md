## ISSUE 03: デコード済みデータの意味解析とマッピング更新

### 概要

`captured_data.jsonl` に記録された EcoFlow Delta Pro 3 からのデコード済み MQTT メッセージについて、各フィールドの具体的な意味を特定し、それに基づいて Protobuf 定義ファイル (`.proto`) および `protobuf_mapping.py` を更新する。

### 背景

Issue 02「受信メッセージの解析・デコード」の完了により、MQTT メッセージのデコード処理が確立され、デバイスからのデータが `captured_data.jsonl` に JSON 形式で保存されるようになった。
しかし、一部のフィールド名が `unknownX` のように汎用的であったり、特定の `cmd_id` / `cmd_func` で受信されるメッセージ全体の意味がドキュメントだけでは不明確な場合がある。
これらのフィールドの正確な意味を特定し、Protobuf 定義やマッピング情報をより具体的で分かりやすいものにすることで、データの活用性を高め、Home Assistant 統合などの後続タスクを円滑に進めることを目指す。

### 主な参照情報

- `captured_data.jsonl`: 実際にデバイスから受信・デコードされたデータ。
- `ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md`: EcoFlow Delta Pro 3 の MQTT パラメータ定義に関する詳細なドキュメント。
- `scripts/ecoflow_mqtt_parser/protobuf_mapping.py`: `cmd_id` / `cmd_func` と Protobuf メッセージ型のマッピング定義。
- `src/ef_dp3_iobroker_pb2.py` (および元の `.proto` ファイル): Protobuf メッセージ構造の定義。

### タスクリスト

1.  **デコード済みデータの意味解析:**
    1.  `captured_data.jsonl` に記録された各メッセージタイプ (特に `cmdFunc50_cmdId30_Report`, `cmdFunc32_cmdId2_Report` など) について、`ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md` の対応するセクション (例: `RuntimePropertyUpload`, `DisplayPropertyUpload`) と照合する。
    2.  各フィールド、特に `unknownX` となっているフィールドについて、ドキュメント内の説明、単位、値の範囲などを参考に具体的な意味を特定する。
    3.  必要に応じて、実際のデバイスの動作や他の情報源 (コミュニティフォーラムなど) も参照し、意味の特定を試みる。
2.  **Protobuf 定義 (`.proto` ファイル) の更新:**
    1.  意味が特定できたフィールドについて、`src/ef_dp3_iobroker.proto` (仮のファイル名、実際の proto ファイル名に合わせる) 内の対応するメッセージ定義で、フィールド名を汎用的なもの (例: `unknown1`) から具体的な意味を表すもの (例: `battery_level_percent`) に変更する。
    2.  コメントを追記し、各フィールドの意味や単位などを明確にする。
    3.  `.proto` ファイル更新後、`protoc` コンパイラを実行して `src/ef_dp3_iobroker_pb2.py` を再生成する。
3.  **`protobuf_mapping.py` の更新:**
    1.  Protobuf メッセージ型名自体がより適切で分かりやすいものに変更できる場合は、`protobuf_mapping.py` のマッピングも更新する。
    2.  デコード処理側で、更新されたフィールド名や型名を正しく扱えるように必要に応じて修正する (主に `message_handler.py` のログ出力やデータ整形部分など、直接的なデコードロジック以外)。
4.  **ドキュメントの更新:**
    1.  特定できたフィールドの意味や、Protobuf 定義の変更点などを関連ドキュメント (例: `docs_4ai/technical.md` や、この Issue ファイル自体) に記録する。

### 期待される成果

- EcoFlow Delta Pro 3 から受信する MQTT データの各フィールドの意味が明確になる。
- Protobuf 定義ファイルおよび Python の生成コードが、より具体的で理解しやすいフィールド名を持つようになる。
- `protobuf_mapping.py` が最新の Protobuf 定義と整合性が取れた状態になる。
- 後続の Home Assistant Entity へのマッピング作業や、データ活用のための分析が容易になる。

### フィールド解析メモ (captured_data.jsonl と deltapro3.md の照合)

以下は、`captured_data.jsonl` に記録されたメッセージと `ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md` のパラメータ定義を照合した結果のメモです。
特に `unknownX` となっているフィールドの意味の特定を試みています。

#### cmdFunc50_cmdId30_Report (RuntimePropertyUpload 相当と推測)

`src: 3` (BMS?) から `dest: 32` (App?) へ送信されるメッセージ。BMS 関連の詳細なランタイムデータが多い。

| `captured_data.jsonl` のキー | サンプル値 (msg_seq: 4) | `deltapro3.md` / 開発者ドキュメントでの対応候補                                  | 型 (proto 推測) | 単位/値範囲/説明 (ドキュメントより)                                                                        | メモ・推測                                                                     |
| ---------------------------- | ----------------------- | -------------------------------------------------------------------------------- | --------------- | ---------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------ |
| `unknown1`                   | 0                       | `bmsFltState`? (`diagnostic`)                                                    | sint32          | {0:OK?}                                                                                                    | BMS 故障状態 (0 なら OK)                                                       |
| `unknown2`                   | 1                       | `bmsProState`? (`diagnostic`)                                                    | sint32          | {0:OK?}                                                                                                    | BMS 保護状態 (0 なら OK)                                                       |
| `unknown3`                   | 2                       | `bmsAlmState`? (`diagnostic`)                                                    | sint32          | {0:OK?}                                                                                                    | BMS 警告状態 (0 なら OK)                                                       |
| `unknown4`                   | 0                       | `bmsBalState`? (`diagnostic`)                                                    | sint32          | {0:OK?}                                                                                                    | BMS バランス状態 (0 なら OK)                                                   |
| `unknown5`                   | 50332521                | -                                                                                | uint64?         | -                                                                                                          | BMS 関連の ID かカウンタ?                                                      |
| `unknown6`                   | 23                      | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown7`                   | 51510                   | `bmsBattVol` (mV) / `bmsMaxCellTemp`の下の`bmsBattSoc`                           | sint32          | `bmsBattVol`: -<br />`bmsBattSoc`: SOC of the main battery.                                                | `bmsBattVol` (51.510V) が有力。`bmsBattSoc`は float 型のはず。                 |
| `unknown8`                   | -8938                   | `bmsBattAmp` (mA 単位)                                                           | sint32          | -80-80A (開発者ドキュメントに直接記載なし、ioBroker 情報)                                                  | バッテリー電流 (-8.938A、放電)                                                 |
| `unknown9`                   | 30                      | `bmsMaxCellTemp` (°C)                                                            | sint32          | Temperature of the main battery (°C).                                                                      | 主バッテリー最高温度。`maxCellTemp18` と重複。                                 |
| `unknown10`                  | 1                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown11`                  | 80000                   | `bmsDesignCap` (mAh)                                                             | uint32          | Battery capacity (mAh).                                                                                    | バッテリー設計容量。`unknown24` と重複。                                       |
| `remainCap12`                | 18510                   | `bmsRemainCap` (mAh) (`ioBroker`のドキュメントより)                              | uint32          | - (開発者ドキュメントに直接の記載なし)                                                                     | バッテリー残容量。                                                             |
| `unknown13`                  | 80000                   | `bmsFullCap` (mAh) (`ioBroker`のドキュメントより)                                | uint32          | - (開発者ドキュメントに直接の記載なし)                                                                     | バッテリー満充電容量。                                                         |
| `unknown14`                  | 153                     | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown15`                  | 100                     | `bmsBattSoh` (%) (`ioBroker`のドキュメントより)                                  | uint32          | - (開発者ドキュメントに直接の記載なし)                                                                     | 主バッテリー SOH。 `soh54` (float) と比較要。                                  |
| `maxCellVol16`               | 3232                    | `bmsMaxCellVol` (mV, mult 0.001) (`ioBroker`より。開発者ドキュメントは V 単位か) | uint32          | 0-5V (x0.001) (`ioBroker`)                                                                                 | 最大セル電圧 (3.232V)                                                          |
| `minCellVol17`               | 3205                    | `bmsMinCellVol` (mV, mult 0.001) (`ioBroker`より。開発者ドキュメントは V 単位か) | uint32          | 0-5V (x0.001) (`ioBroker`)                                                                                 | 最小セル電圧 (3.205V)                                                          |
| `maxCellTemp18`              | 30                      | `bmsMaxCellTemp` (°C)                                                            | sint32          | Temperature of the main battery (°C).                                                                      | 主バッテリー最高温度 (`unknown9` と重複)                                       |
| `minCellTemp19`              | 28                      | `bmsMinCellTemp` (°C)                                                            | sint32          | Minimum temperature of the main battery (°C).                                                              | 主バッテリー最低温度。                                                         |
| `maxMosTemp20`               | 28                      | `bmsMaxMosTemp` (°C) (`ioBroker`より)                                            | sint32          | 0-100 °C (`ioBroker`) (開発者ドキュメントに直接の記載なし)                                                 | BMS MOS 最大温度                                                               |
| `minMosTemp21`               | 27                      | `bmsMinMosTemp` (°C) (`ioBroker`より)                                            | sint32          | 0-100 °C (`ioBroker`) (開発者ドキュメントに直接の記載なし)                                                 | BMS MOS 最小温度                                                               |
| `unknown22`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown23`                  | 3                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown24`                  | 80000                   | `bmsDesignCap` (mAh) (再掲)                                                      | uint32          | Battery capacity (mAh).                                                                                    | バッテリー設計容量 (`unknown11` と重複)                                        |
| `unknown25`                  | 23.137522               | `bmsBattSoc` (%)                                                                 | float           | SOC of the main battery.                                                                                   | 主バッテリー SOC。`unknown42`, `unknown44` と類似値。                          |
| `unknown26`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown27`                  | 460                     | `bmsChgRemTime` (min)                                                            | uint32          | Remaining charging time of the main battery (min).                                                         | 主バッテリー充電残時間。                                                       |
| `unknown28`                  | 619                     | `bmsDsgRemTime` (min)                                                            | uint32          | Remaining discharging time (min).                                                                          | 主バッテリー放電残時間。                                                       |
| `unknown29`                  | 3                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown30`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown31`                  | 27                      | `bmsMaxMosTemp` (°C) (`ioBroker`より) (再掲)                                     | sint32          | 0-100 °C (`ioBroker`) (開発者ドキュメントに直接の記載なし)                                                 | BMS MOS 最大温度 (`unknown20` と重複)                                          |
| `unknown32`                  | 16                      | -                                                                                | sint32          | -                                                                                                          | セル電圧配列の要素数か? (`cellVol33` は 16 要素)                               |
| `cellVol33`                  | `[3223, ...]`           | -                                                                                | repeated uint32 | mV?                                                                                                        | 各セル電圧 (16 セル分)                                                         |
| `unknown34`                  | 8                       | -                                                                                | sint32          | -                                                                                                          | セル温度配列の要素数か? (`cellTemp35` は 8 要素)                               |
| `cellTemp35`                 | `[28, ...]`             | -                                                                                | repeated sint32 | °C?                                                                                                        | 各セル温度 (8 個所分)                                                          |
| `version36`                  | "575d35"                | `bmsFirmVer` (string) (`ioBroker`より)                                           | string          | - (開発者ドキュメントに直接の記載なし)                                                                     | BMS ファームウェアバージョン                                                   |
| `bmsHeartVer37`              | 262                     | -                                                                                | uint32          | -                                                                                                          | BMS ハートビートバージョン?                                                    |
| `ecloudOcv38`                | 65535                   | -                                                                                | uint32          | -                                                                                                          | OCV (Open Circuit Voltage)関連? 65535 は無効値か                               |
| `deveiceSn39`                | "311e..."               | BMS Serial Number (仮称)                                                         | string          | -                                                                                                          | BMS のシリアル番号?                                                            |
| `unknown40`                  | 28                      | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown41`                  | 2                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown42`                  | 23.137857               | `bmsBattSoc` (%) (再掲)                                                          | float           | SOC of the main battery.                                                                                   | 主バッテリー SOC (`unknown25`, `unknown44` と類似)                             |
| `unknown43`                  | 0.9605322               | -                                                                                | float           | -                                                                                                          |                                                                                |
| `unknown44`                  | 23.137857               | `bmsBattSoc` (%) (再掲)                                                          | float           | SOC of the main battery.                                                                                   | 主バッテリー SOC (`unknown25`, `unknown42` と類似)                             |
| `unknown45`                  | -1                      | -                                                                                | sint32          | -1 は無効値や未設定を示すことが多い                                                                        |                                                                                |
| `unknown46`                  | 3                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown47`                  | 1                       | `bmsChgDsgState`                                                                 | sint32          | Charging/Discharging status of the main battery. 0: not charging/discharging, 1: discharging, 2: charging. | 充電/放電状態 (1 なら放電)。                                                   |
| `unknown48`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown49`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown50`                  | 12283595                | -                                                                                | uint64?         | -                                                                                                          |                                                                                |
| `unknown51`                  | 10159279                | -                                                                                | uint64?         | -                                                                                                          |                                                                                |
| `unknown52`                  | 99.95355                | -                                                                                | float           | -                                                                                                          | SOH 関連の値か？                                                               |
| `unknown53`                  | 0.0                     | -                                                                                | float           | -                                                                                                          |                                                                                |
| `soh54`                      | 99.9336                 | `bmsBattSoh` (%) (ioBroker 情報と型から推測)                                     | float           | - (開発者ドキュメントに直接の記載なし)                                                                     | バッテリー SOH。`unknown15` (uint32) と比較。こちらがより正確な SOH の可能性。 |
| `unknown55`                  | 3                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `mosTemp56`                  | `[27, ...]`             | -                                                                                | repeated sint32 | °C?                                                                                                        | MOS 温度 (3 個所分)                                                            |
| `unknown57`                  | 1                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown58`                  | `[25]`                  | -                                                                                | repeated sint32 | -                                                                                                          |                                                                                |
| `unknown61`                  | 1                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown62`                  | `[27]`                  | -                                                                                | repeated sint32 | -                                                                                                          |                                                                                |
| `unknown63`                  | 25                      | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown64`                  | 25                      | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown67`                  | 27                      | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown68`                  | 27                      | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown69`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `error70`                    | `[0, ...]`              | `bmsErrCode`? (ただし型違い) (`ioBroker`より)                                    | repeated uint32 | - (開発者ドキュメントに直接の記載なし)                                                                     | BMS エラーコード配列 (16 要素) 各要素がエラーフラグか。0 はエラーなし。        |
| `unknown71`                  | 3                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `batVolt72`                  | `[53687]`               | `bmsBattVol` (mV) (再掲)                                                         | repeated sint32 | - (開発者ドキュメントに直接の記載なし、ioBroker 情報)                                                      | バッテリー電圧 (配列だが通常 1 要素)                                           |
| `unknown73`                  | 91239                   | -                                                                                | uint32          | -                                                                                                          |                                                                                |
| `unknown74`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown75`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown76`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown77`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown78`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |
| `unknown79`                  | 667014                  | -                                                                                | uint64?         | -                                                                                                          |                                                                                |
| `unknown80`                  | 538378                  | -                                                                                | uint64?         | -                                                                                                          |                                                                                |
| `packSn81`                   | "d34d..."               | Battery Pack SN (仮称)                                                           | string          | -                                                                                                          | バッテリーパックのシリアル番号?                                                |
| `unknown82`                  | 0                       | -                                                                                | sint32          | -                                                                                                          |                                                                                |

#### cmdFunc32_cmdId2_Report (CMS/BMS のサマリー情報や充電制御関連情報と推測)

`src: 3` (BMS?) から `dest: 32` (App?) へ送信されるメッセージ。ネストした構造 (`msg32_2_1`, `msg32_2_2`) を持つ。

| `captured_data.jsonl` のキー | サンプル値 (msg_seq: 5) | `deltapro3.md` / 開発者ドキュメントでの対応候補                      | 型 (proto 推測) | 単位/値範囲/説明 (ドキュメントより)                                                                                                       | メモ・推測                                                                                                       |
| ---------------------------- | ----------------------- | -------------------------------------------------------------------- | --------------- | ----------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- |
| `msg32_2_1.unknown1`         | 1                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown2`         | 1                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown3`         | 1                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.volt4`            | 53350                   | `cmsBattVol` (mV) (`ioBroker`より。開発者ドキュメントに直接記載なし) | sint32          | Overall SOC の下に`cmsBattSoc`はあるが`cmsBattVol`はなし。                                                                                | CMS バッテリー電圧 (53.350V)                                                                                     |
| `msg32_2_1.unknown5`         | 130000                  | `cmsChgReqAmp`? (mA 単位?) (`ioBroker`より)                          | uint32          | 0-80A (開発者ドキュメントに直接記載なし、ioBroker 情報)                                                                                   | CMS 充電要求電流? (130A は大きすぎる。A 単位で 130.000A か、別のパラメータ)                                      |
| `msg32_2_1.unknown6`         | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.maxChargeSoc7`    | 100                     | `cmsMaxChgSoc` (%)                                                   | uint32          | Charge limit.                                                                                                                             | 充電上限 SOC。                                                                                                   |
| `msg32_2_1.unknown8`         | 5                       | `cmsMinDsgSoc` (%)                                                   | uint32          | Discharge limit.                                                                                                                          | 放電下限 SOC。                                                                                                   |
| `msg32_2_1.unknown9`         | 61                      | `acOutFreq` (Hz)                                                     | uint32          | AC output frequency.                                                                                                                      | AC 出力周波数。DeltaPro3 ドキュメントの Set コマンド例では `cfgAcOutFreq`、Quota では`acOutFreq`。               |
| `msg32_2_1.unknown10`        | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown11`        | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown12`        | 400                     | `cmsChgRemTime` (min)                                                | uint32          | Remaining charging time (min).                                                                                                            | CMS 充電残時間。                                                                                                 |
| `msg32_2_1.unknown13`        | 619                     | `cmsDsgRemTime` (min)                                                | uint32          | Remaining discharging time (min).                                                                                                         | CMS 放電残時間。                                                                                                 |
| `msg32_2_1.unknown14`        | 1                       | `cmsChgDsgState`                                                     | sint32          | Charging/Discharging status. 0: not charging or discharging, 1: discharging, 2: charging.                                                 | CMS 充放電状態 (1 なら放電)。                                                                                    |
| `msg32_2_1.soc15`            | 61.260773               | `cmsBattSoc` (%)                                                     | float           | Overall SOC.                                                                                                                              | CMS バッテリー SOC。                                                                                             |
| `msg32_2_1.bmsIsConnt16`     | `[3,0,3]`               | -                                                                    | repeated sint32 | -                                                                                                                                         | BMS 接続状態 (複数パック対応? 各要素がパックの接続状態やタイプを示す可能性)                                      |
| `msg32_2_1.unknown17`        | 2                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown18`        | 1                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown19`        | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown20`        | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown21`        | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown22`        | 88                      | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_1.unknown23`        | 100                     | `cmsOilOffSoc` (%) / `cmsOilOnSoc` (%)                               | uint32          | `cmsOilOffSoc`: SOC for automatically stopping the Smart Generator.<br>`cmsOilOnSoc`: SOC for automatically stopping the Smart Generator. | スマートジェネレータ自動停止 SOC (`cmsOilOffSoc`) または開始 SOC (`cmsOilOnSoc`)。値から`cmsOilOffSoc`が妥当か。 |
| `msg32_2_2.unknown1`         | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_2.unknown2`         | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_2.unknown3`         | 0                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_2.unknown4`         | 1                       | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |
| `msg32_2_2.unknown5`         | 259                     | -                                                                    | sint32          | -                                                                                                                                         |                                                                                                                  |

**注意点:**

- 上記の対応付けはあくまで現時点での推測であり、実際の Protobuf 定義 (`.proto`ファイル) や追加のドキュメント、デバイスの挙動と照らし合わせて検証が必要です。
- `unknownX` フィールドの中には、予約領域や内部的なフラグなど、直接ユーザーが意識する必要のない情報も含まれている可能性があります。
- 同じパラメータが複数のメッセージタイプやフィールドで報告されることもあります (例: SOC, 電圧など)。
- `DisplayPropertyUpload` に記載のあるパラメータでも、`cmdFunc50_cmdId30_Report` (Runtime 相当) に含まれてくることがあります。デバイスからのデータ送信の効率化や実装の都合によるものと考えられます。
- 数値の単位 (例: mV vs V, mA vs A) やスケールファクター (mult) に注意が必要です。
