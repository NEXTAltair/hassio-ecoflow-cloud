# Delta Pro3 仕様調査タスク

## 1. MQTT/Protobuf 仕様調査

- [x] MQTT ブローカーの接続方式調査
  - 例: mqtt.ecoflow.com への接続方法、認証情報の取得方法
  - **参考: ioBroker.ecoflow-mqtt, GitHub issue #270**
  - EcoFlow 公式 MQTT ブローカー(mqtt.ecoflow.com)に接続するには、以下の認証情報が必要:
    - UserName(例: app-xxxx...)
    - UserID(19 桁の数字)
    - UserPassword(英数字)
    - ClientID(ANDROID_xxxx... で始まる文字列)
  - 認証情報の取得方法:
    1. [ecoflow-withoutflow/cloud-mqtt/ecoflow_get_mqtt_login.sh](https://github.com/mmiller7/ecoflow-withoutflow/blob/main/cloud-mqtt/ecoflow_get_mqtt_login.sh) スクリプトを使う
    2. [energychain.github.io/site_ecoflow_mqtt_credentials/](https://energychain.github.io/site_ecoflow_mqtt_credentials/) の Web サイトで取得 **(この方法で認証情報を取得済み)**。このサイトでは、EcoFlow アカウントのメールアドレス、パスワード、およびデバイスのシリアル番号を入力することで MQTT 認証情報を取得できる。
    3. ioBroker.ecoflow-mqtt アダプタの「ボタンを押す」機能(EcoFlow アカウントのユーザー名・パスワードが必要)
    4. `ioBroker.ecoflow-mqtt/lib/ecoflow_utils.js` の `getEcoFlowMqttCredits` 関数のロジックを参考に、API (`https://api.ecoflow.com/auth/login`, `https://api.ecoflow.com/iot-auth/app/certification`) を直接呼び出して取得する。
  - MQTT ブローカーのアドレスやポートは通常デフォルト(mqtt.ecoflow.com:1883)
  - 場合によっては Web サイト ② で異なるブローカーアドレスが返ることもあるので注意
  - 取得した認証情報を使い、MQTT クライアント(Node-RED や ioBroker 等)で接続設定を行う
  - 参考: [ioBroker.ecoflow-mqtt README](https://github.com/foxthefox/ioBroker.ecoflow-mqtt#ef-credentials)
- [x] Delta Pro3 の MQTT トピック構造調査 - 2025/05/29 完了
  - 例: /app/xxxx/thing/property/get など、どのトピックでどんなデータが流れるか
  - **概要:** Delta Pro 3 の MQTT 通信では、標準的なトピック構造（`set`, `set_reply`, `get`, `get_reply`, 定期更新）が使用されます。ペイロードは全て Protobuf 形式です。
    - データ取得要求: `/app/{USER_ID}/{DEVICE_SN}/thing/property/set` (ioBroker では `getLastProtobufQuotas` に相当するメッセージを送信)
    - データ取得応答: `/app/{USER_ID}/{DEVICE_SN}/thing/property/get_reply` (上記要求への応答)
    - 定期更新/ハートビート: `/app/device/property/{DEVICE_SN}` (デバイスからの定期的な状態通知)
  - **詳細なトピック構造、メッセージ形式、Protobuf 定義、コマンド ID、および `ioBroker.ecoflow-mqtt/lib/dict_data/ef_deltapro3_data.js` の解析結果については、[こちらの詳細ドキュメント](tasks/rfc/00_01_DP3_MQTTトピック構造詳細.md) を参照してください。**
- [x] Delta Pro3 の MQTT メッセージ形式調査 - 2025/05/29 完了
  - 例: Protobuf 形式か JSON 形式か、バイナリかテキストか
  - **確定事項:** Delta Pro3 の MQTT メッセージのペイロードは **Protobuf (Protocol Buffers)** 形式。
  - **エンコード/デコードフロー:**
    - **送信時 (クライアント -> デバイス):**
      - データ取得要求 (`cmdId:1, cmdFunc:20` または ioBroker の `cmdFunc: 2, cmdId: 255` など) の場合、`Header` または `setMessage` (内部で `setHeader` を使用) 型の Protobuf メッセージを構築し、シリアライズしてそのままバイナリで送信する。
    - **受信時 (デバイス -> クライアント):**
      - `/app/device/property/{DEVICE_SN}` トピックのメッセージ:
        - ペイロードは Base64 エンコードされていないことが多い。
        - まず `HeaderMessage` 型としてデコード。
        - `HeaderMessage` 内の各 `Header` を取り出す。
        - 各 `Header` の `pdata` フィールドに対し、`enc_type == 1 && src != 32` の条件で `seq` をキーとして XOR デコードを実行。
        - XOR デコード後の `pdata` を、`Header` の `cmd_id` と `cmd_func` に基づき、`protobuf_mapping.py` で定義された特定の Protobuf メッセージ型 (例: `DisplayPropertyUpload`, `cmdFunc50_cmdId30_Report`) にデコード。
      - `/app/{USER_ID}/{DEVICE_SN}/thing/property/get_reply` トピックのメッセージ:
        - ペイロードの先頭バイトによって処理が異なる可能性あり (`0x01`, `0x02` は特殊型、`0x0a` は通常の Length-delimited)。
        - ioBroker の実装では Base64 デコードと `HeaderMessage` としてのパースを試みる部分もある。
        - 現状の Python スクリプトではこのトピックからのメッセージは未確認。
  - **Protobuf 定義の元:**
    - 主に `ioBroker.ecoflow-mqtt/lib/dict_data/ef_deltapro3_data.js` 内の `protoSource` を抽出し、`scripts/ef_dp3_iobroker.proto` として保存、これをコンパイルして `ef_dp3_iobroker_pb2.py` を生成して使用。
- [x] Protobuf メッセージのサンプル収集 - 2025/05/29 完了
  - `scripts/ecoflow_mqtt_parser/` 配下のスクリプト群を用いて、`captured_data.jsonl` に受信メッセージのデコード結果を収集済み。
  - これにより、実際の `cmd_id`, `cmd_func` とペイロード内容の関連を分析可能になった。
- [x] Protobuf スキーマ(.proto ファイル)の入手・推測 - 2025/05/29 完了
  - **入手元:** `ioBroker.ecoflow-mqtt` の `lib/dict_data/ef_deltapro3_data.js` 内の `protoSource`。
  - **生成:** 上記 `protoSource` を `.proto` ファイルとして保存し、`protoc` で Python 用の `ef_dp3_iobroker_pb2.py` を生成。
  - **主要メッセージ型:** `Header`, `HeaderMessage`, `setMessage`, `setHeader`, `setValue` 及び、`ef_deltapro3_data.js` の `protoMsg` オブジェクトで定義される各種デバイス固有メッセージ (例: `DisplayPropertyUpload`, `RuntimePropertyUpload` など)。
  - **`pdata` の型に関する注意:**
    - `setHeader.pdata` は `.proto` 上では `setValue` 型だが、ioBroker の実装では `bytes` 型のように扱われ XOR デコードの対象となる。Python の `protobuf` ライブラリはスキーマに厳格なため、このミスマッチへの対応が必要だった (現在は `pdata` をバイト列として処理するロジックで対応)。
- [x] 主要なフィールドと値の意味の特定 - 進行中 (`issue_03_data_analysis_and_mapping_update.md` で対応)
  - `captured_data.jsonl` と `ioBroker.ecoflow-mqtt/doc/devices/deltapro3.md` を照合し、`unknownX` フィールドの意味を特定中。
  - 例:
    - `cmdFunc50_cmdId30_Report` (BMS ランタイムデータ): `bmsBattVol`, `bmsBattAmp`, `bmsMaxCellTemp`, `bmsRemainCap`, `bmsBattSoc` など。
    - `cmdFunc32_cmdId2_Report` (CMS/BMS サマリー): `cmsBattVol`, `cmsMaxChgSoc`, `cmsMinDsgSoc`, `cmsBattSoc` など。
  - 詳細は `tasks/issues/issue_03_data_analysis_and_mapping_update.md` のフィールド解析メモを参照。
- [x] コマンド送信時のメッセージ構造調査 - 2025/05/29 完了
  - **データ取得要求:**
    - Python スクリプトでは `cmdId:1, cmdFunc:20` を設定した `Header` メッセージを `/app/{USER_ID}/{DEVICE_SN}/thing/property/set` に送信。 (`from` フィールドは現在送信していない)
    - ioBroker の `getLastProtobufQuotas` では `cmdFunc: 2, cmdId: 255` を `setHeader` に設定した `setMessage` を使用。ペイロードは空に近い。
  - **その他のコマンド:**
    - ioBroker の `prepareStreamCmd` や `prepareStationCmd` が参考になるが、Delta Pro 3 は主に Protobuf ベース。
    - 設定変更などのコマンドは、特定の `cmdId`, `cmdFunc` と対応するペイロードを持つ `Header` (または `setMessage`) を構築して送信すると推測される。
    - 具体的なコマンドごとの `cmdId`, `cmdFunc`, ペイロード構造の詳細は、`ioBroker.ecoflow-mqtt/lib/dict_data/ef_deltapro3_data.js` の `deviceCmd` や `protoCommands` の定義を参照する必要がある。

## 2. 既存定義・構造調査

- [ ] delta_pro.py, delta2_max.py など既存デバイス定義の項目一覧化
  - 例: センサー/スイッチ/スライダー/セレクトのリストアップ
  - **参考ファイル:**
    - custom_components/ecoflow_cloud/devices/internal/delta_pro.py
    - custom_components/ecoflow_cloud/devices/internal/delta2_max.py
  - **センサー(例: Delta Pro):**
    | 種別 | エンティティ名例 | 属性/説明 |
    |--------------|-------------------------------|---------------------------------|
    | Level | bmsMaster.soc | メインバッテリー残量 |
    | Level | bmsMaster.f32ShowSoc | メインバッテリー残量(float) |
    | Capacity | bmsMaster.designCap | 設計容量 |
    | Capacity | bmsMaster.fullCap | フル容量 |
    | Capacity | bmsMaster.remainCap | 残容量 |
    | Level | bmsMaster.soh | SOH |
    | Level | ems.lcdShowSoc | 複合バッテリー残量 |
    | Watts | pd.wattsInSum | 合計入力 W |
    | Watts | pd.wattsOutSum | 合計出力 W |
    | InWatts | inv.inputWatts | AC 入力 W |
    | OutWatts | inv.outputWatts | AC 出力 W |
    | InMilliVolt | inv.acInVol | AC 入力 V |
    | OutMilliVolt | inv.invOutVol | AC 出力 V |
    | InWattsSolar | mppt.inWatts | ソーラー入力 W |
    | InVoltSolar | mppt.inVol | ソーラー入力 V |
    | InAmpSolar | mppt.inAmp | ソーラー入力 A |
    | OutWattsDc | mppt.outWatts | DC 出力 W |
    | OutVoltDc | mppt.outVol | DC 出力 V |
    | ... | ... | ...(他、多数) |
  - **スイッチ(例: Delta Pro):**
    | エンティティ名例 | 説明 |
    |--------------------------|---------------------------|
    | pd.beepState | ビーパー ON/OFF |
    | mppt.carState | DC 出力 ON/OFF |
    | inv.cfgAcEnabled | AC 出力 ON/OFF |
    | inv.cfgAcXboost | X-Boost ON/OFF |
    | pd.acautooutConfig | AC 常時出力 ON/OFF |
    | pd.watthisconfig | バックアップ電源設定 |
  - **スライダー/ナンバー(例: Delta Pro):**
    | エンティティ名例 | 説明 |
    |--------------------------|---------------------------|
    | ems.maxChargeSoc | 充電上限(%) |
    | ems.minDsgSoc | 放電下限(%) |
    | pd.bppowerSoc | バックアップリザーブ(%) |
    | ems.minOpenOilEbSoc | 発電機自動起動しきい値(%) |
    | ems.maxCloseOilEbSoc | 発電機自動停止しきい値(%) |
    | inv.cfgSlowChgWatts | AC 充電パワー(W) |
  - **セレクト(例: Delta Pro):**
    | エンティティ名例 | 説明 |
    |--------------------------|---------------------------|
    | mppt.cfgDcChgCurrent | DC 充電電流選択 |
    | pd.lcdOffSec | LCD オフタイマー |
    | pd.standByMode | スタンバイモード |
    | inv.cfgStandbyMin | AC スタンバイタイマー |
  - **Delta2 Max も同様に多数のセンサー・スイッチ・スライダー・セレクトを持つ。**
    - センサー: bms_bmsStatus.soc, mppt.inWatts, inv.inputWatts, ...
    - スイッチ: pd.beepMode, pd.dcOutState, inv.cfgAcEnabled, ...
    - スライダー: bms_emsStatus.maxChargeSoc, bms_emsStatus.minDsgSoc, ...
    - セレクト: pd.lcdOffSec, inv.standbyMin, mppt.carStandbyMin, ...
  - **備考:**
    - 各エンティティは、`custom_components/ecoflow_cloud/devices/internal/` 配下の各.py で `sensors`/`switches`/`numbers`/`selects` メソッドにより定義されている。
    - 実際の項目名・属性は const.py や各 Entity クラスの定義も参照。
    - DP3 対応時は、これら既存定義をベースに、DP3 特有の項目追加・調整を行う。
- [ ] 既存デバイスのデータパース・エンティティ生成ロジック調査
  - 例: どのようにデータを受け取り、Home Assistant のエンティティに変換しているか
  - **全体フロー:**
    1. **MQTT 受信**
       - `EcoflowMQTTClient`(`api/ecoflow_mqtt.py`)が各トピックでメッセージ受信。
       - 受信時、各デバイス(`BaseDevice`継承クラス)に `update_data(payload, topic)` を呼び出す。
    2. **データパース・格納**
       - `BaseDevice.update_data()` でトピック種別ごとに `_prepare_data()` でデータをパース。
       - デフォルトは JSON デコード。Protobuf 対応デバイスは各デバイスでオーバーライドし、バイナリ →XOR→Protobuf デコード等を実装。
       - パース後のデータは `EcoflowDataHolder`(`devices/data_holder.py`)の `params` 等に格納。
    3. **エンティティ生成**
       - 各デバイス(例: `DeltaPro`, `Delta2Max`)は `sensors()`/`switches()`/`numbers()`/`selects()` でエンティティリストを返す。
       - 各エンティティは `entities/__init__.py` の `EcoFlowDictEntity`/`BaseSensorEntity` などを継承。
    4. **Home Assistant 連携**
       - 各プラットフォームの `async_setup_entry()` で `device.sensors(client)` などを呼び出し、エンティティを登録。
       - エンティティは `CoordinatorEntity` として `coordinator`(デバイスの `EcoflowDeviceUpdateCoordinator`)のデータ更新を購読。
    5. **値の更新・反映**
       - データ更新時、`_handle_coordinator_update()` → `_updated(data)` で `params` から値を抽出し、エンティティの状態を更新。
       - `mqtt_key` で `params` 内の値を `jsonpath_ng` で抽出。
       - 値が変化した場合、Home Assistant の状態が自動で更新される。
  - **主要クラス・関数:**
    - `EcoflowMQTTClient`(MQTT 受信・publish)
    - `BaseDevice`(データパース・保持・エンティティ生成)
    - `EcoflowDataHolder`(データ保持・履歴管理)
    - `EcoFlowDictEntity`/`BaseSensorEntity` など(エンティティの値更新ロジック)
  - **備考:**
    - Protobuf 対応時は `_prepare_data()` のオーバーライドが必須。
    - データ構造やパース処理は DP3 対応時に再設計・拡張が必要な場合あり。

## 3. 参考情報・コミュニティ調査

- [ ] ioBroker.ecoflow-mqtt の Delta Pro3 対応状況調査
  - 例: 実装例やスキーマ、データマッピングの有無
  - **対応状況(2024 年 5 月時点):**
    - バージョン 1.3.0 で「Delta Pro 3 implementation」として公式に対応が追加。
    - [Changelog](https://github.com/foxthefox/ioBroker.ecoflow-mqtt#changelog)や[README](https://github.com/foxthefox/ioBroker.ecoflow-mqtt#implemented-devices--structure-with-datapoints)にも Delta Pro 3 の記載あり。
    - デバイス追加時に「Delta Pro 3」を選択可能。
  - **データマッピング・スキーマ:**
    - Protobuf ベースでのデータ受信・コマンド送信に対応。
    - コミュニティ(GitHub Issue #193, #270)で cmdId ごとのフィールド解析が進行中。
    - [AppShowHeartbeatReport.proto](https://github.com/tolwi/hassio-ecoflow-cloud/files/14321255/AppShowHeartbeatReport.proto.txt) など、主要な cmdId(1,2,3,4)の.proto ファイルが公開・流用可能。
    - Heartbeat や get_reply のデータは XOR デコード後に Protobuf でパース可能。
    - コマンド送信も Protobuf 形式で、cmdId=32 等で AC 出力 ON/OFF や設定変更が可能。
  - **実装例:**
    - [lib/ecoflow_data.js](https://github.com/foxthefox/ioBroker.ecoflow-mqtt/blob/main/lib/ecoflow_data.js)・[lib/parser.js](https://github.com/foxthefox/ioBroker.ecoflow-mqtt/blob/main/lib/parser.js)に DP3/Ultra 系のデータパース・マッピング実装あり。
    - データポイント(state 名・型・単位等)は adapter 起動時に自動生成され、HA の MQTT Discovery 経由で Home Assistant に連携。
  - **コミュニティ解析状況:**
    - [hassio-ecoflow-cloud Issue #193, #270](https://github.com/tolwi/hassio-ecoflow-cloud/issues/193)で DP3/Ultra のフィールド解析・サンプルデータ共有が活発。
    - XOR デコード・Protobuf パース・フィールド推測の手法が確立。
    - heartbeat(pdata)の XOR デコード方法や、主要なフィールド番号・意味も議論・共有されている。
  - **備考:**
    - ioBroker.ecoflow-mqtt の DP3 対応実装は、hassio-ecoflow-cloud やコミュニティの解析成果を積極的に取り込んでいる。
    - 公式 API/SDK は未公開のため、今後もサンプルデータ・フィールド推測の精度向上が期待される。
    - 実装・解析の進捗は GitHub Issue や Changelog を随時確認すること。
- [ ] GitHub issue #270 等のコミュニティ解析情報収集
  - 例: 実際のデータ例、フィールド推測、既知の課題
  - **参考情報源:**
    - [hassio-ecoflow-cloud Issue #270 (Delta Pro 3)](https://github.com/tolwi/hassio-ecoflow-cloud/issues/270)
    - [hassio-ecoflow-cloud Issue #193 (Delta Pro Ultra)](https://github.com/tolwi/hassio-ecoflow-cloud/issues/193)
    - [ioBroker.ecoflow-mqtt](https://github.com/foxthefox/ioBroker.ecoflow-mqtt)
  - **実際のデータ例:**
    - コミュニティユーザーが Node-RED や MQTT Explorer で取得した DP3 の MQTT メッセージ(HEX/BASE64 形式)が多数共有されている。
    - 例: `debug 4`(get_reply/heartbeat)や `debug 5/6`(set/set_reply)など、コマンド操作時・状態取得時の生データ。
    - サンプル: `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`
    - コマンド送信時の例: `CioKA8gBARAgGAIgASgBOANA/gFIEVADWAFww+7SigKAAROIAQG6AQNpb3M=`
  - **フィールド推測・進捗:**
    - foxthefox 氏らが、cmdId=32 等のメッセージに対し、Protobuf スキーマ(例: `message cmdFunc254_cmdId32_Report`)を作成し、フィールド番号ごとに値の意味を推測。
    - 例: `voltage68`(68): AC 出力電圧, `current69`(69): AC 出力電流, `
