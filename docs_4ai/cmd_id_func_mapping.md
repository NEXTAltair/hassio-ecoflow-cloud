# EcoFlow MQTT `cmdId` と `cmdFunc` 対応表

このドキュメントは、EcoFlow デバイス (特に Delta Pro 3) の MQTT 通信で使用される `cmdId` と `cmdFunc` の組み合わせと、それに対応する Protobuf メッセージ型や機能の概要をまとめたものです。

主に `tasks/issues/issue_03_data_analysis_and_mapping_update.md`、`scripts/ef_dp3_iobroker.proto` および `ioBroker.ecoflow-mqtt` のドキュメント、キャプチャされたデータログの解析結果に基づいています。

**注意:**

- この表は現時点での調査結果であり、完全ではない可能性があります。
- `cmdId` や `cmdFunc` の組み合わせによっては、デバイスの種類やファームウェアバージョンによって挙動が異なる場合があります。
- メッセージ名や説明は、解析に基づく推測が含まれている場合があります。

## 受信メッセージ (デバイス -> アプリ/クラウド)

| `cmdFunc` | `cmdId` | Protobuf メッセージ型 (推測/定義)                                                                                               | 送信元 (src) | 備考                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| --------- | ------- | ------------------------------------------------------------------------------------------------------------------------------- | ------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `32`      | `2`     | `cmdFunc32_cmdId2_Report` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L429-L432)) / CMS・BMS サマリー情報、充電制御関連 | `3` (BMS?)   | ネスト構造 (`struct32_2_1`, `struct32_2_2`) を持つ。<br>**`struct32_2_1` の主なフィールド (Issue#03 解析より):**<br> - `volt4` (`cms_batt_vol_mv`): CMS バッテリー電圧 (mV)<br> - `maxChargeSoc7` (`cms_max_chg_soc_percent`): 充電上限 SOC (%)<br> - `unknown8` (`cms_min_dsg_soc_percent`): 放電下限 SOC (%)<br> - `unknown9` (`ac_out_freq_hz_config`): AC 出力周波数 (Hz)<br> - `unknown12` (`cms_chg_rem_time_min`): CMS 充電残時間 (min)<br> - `unknown13` (`cms_dsg_rem_time_min`): CMS 放電残時間 (min)<br> - `unknown14` (`cms_chg_dsg_state`): CMS 充放電状態<br> - `soc15` (`cms_batt_soc_percent`): CMS バッテリー SOC (%)<br> - `bmsIsConnt16`: BMS 接続状態 (配列)<br> - `unknown23` (`cms_oil_off_soc_percent`): スマートジェネレータ自動停止 SOC (%)<br>詳細は [issue_03](mdc:tasks/issues/issue_03_data_analysis_and_mapping_update.md#cmdFunc32_cmdId2_Report) および [proto 定義](mdc:scripts/ef_dp3_iobroker.proto#L395-L420) 参照。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `32`      | `50`    | `cmdFunc50_cmdId30_Report` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L110-L187)) / BMS 詳細ランタイムデータ           | `3` (BMS?)   | **主なフィールド (Issue#03 解析より):**<br> - `unknown1` (`bms_flt_state`): BMS 故障状態<br> - `unknown2` (`bms_pro_state`): BMS 保護状態<br> - `unknown3` (`bms_alm_state`): BMS 警告状態<br> - `unknown4` (`bms_bal_state`): BMS バランス状態<br> - `unknown7` (`bms_batt_vol`): バッテリー電圧 (mV)<br> - `unknown8` (`bms_batt_amp`): バッテリー電流 (mA)<br> - `unknown9`/`maxCellTemp18` (`bms_max_cell_temp_c`): 主バッテリー最高温度 (°C)<br> - `minCellTemp19` (`bms_min_cell_temp_c`): 主バッテリー最低温度 (°C)<br> - `remainCap12` (`bms_remain_cap_mah`): バッテリー残容量 (mAh)<br> - `unknown13` (`bms_full_cap_mah`): バッテリー満充電容量 (mAh)<br> - `unknown15`/`soh54` (`bms_batt_soh_percent_float`): バッテリー SOH (%)<br> - `maxCellVol16` (`max_cell_vol_mv`): 最大セル電圧 (mV)<br> - `minCellVol17` (`min_cell_vol_mv`): 最小セル電圧 (mV)<br> - `unknown25`/`unknown42`/`unknown44` (`bms_batt_soc_percent_float1`): SOC (% float)<br> - `unknown27` (`bms_chg_rem_time_min`): 充電残時間 (min)<br> - `unknown28` (`bms_dsg_rem_time_min`): 放電残時間 (min)<br> - `cellVol33` (`cell_vol_mv`): 各セル電圧 (mV 配列)<br> - `cellTemp35` (`cell_temp_c`): 各セル温度 (°C 配列)<br> - `version36` (`bms_firm_ver`): BMS FW バージョン<br> - `unknown47` (`bms_chg_dsg_state`): 充電/放電状態<br> - `error70` (`bms_err_code_flags`): BMS エラーコード配列<br> - `packSn81` (`pack_sn`): バッテリーパック SN<br>詳細は [issue_03](mdc:tasks/issues/issue_03_data_analysis_and_mapping_update.md#cmdFunc50_cmdId30_Report) および [proto 定義](mdc:scripts/ef_dp3_iobroker.proto#L110-L187) 参照。 |
| `254`     | `21`    | `DisplayPropertyUpload` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L234-L388)) / 表示用プロパティ                      | -            | デバイスの表示画面に関連する各種ステータスや設定値。ioBroker ドキュメント (`deltapro3.md` 等) の "Quota" セクションに記載されているパラメータ群に相当。多数のフィールドを持つ。例: `pow_in_sum_w`, `pow_out_sum_w`, `lcd_light`, `energy_backup_state`, `xboost_en`, `bms_batt_soc`, `cms_max_chg_soc` 等。詳細は [proto 定義](mdc:scripts/ef_dp3_iobroker.proto#L234-L388)参照。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| `254`     | `22`    | `RuntimePropertyUpload` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L3-L108)) / ランタイムプロパティ                    | -            | `DisplayPropertyUpload` と類似するが、より頻繁に更新されるランタイムデータか。多数のフィールドを持つ。例: `ac_phase_type`, `pcs_work_mode`, `temp_pcs_dc`, `plug_in_info_pv_h_vol`, `pd_mppt_comm_err`, `bms_batt_vol`, `cms_batt_soc` 等。詳細は [issue_03 のログ解析](mdc:tasks/issues/issue_03_data_analysis_and_mapping_update.md#2025-05-29-1118-実行ログ解析) および [proto 定義](mdc:scripts/ef_dp3_iobroker.proto#L3-L108)参照。新規確認されたメッセージ。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| `2`       | `255`   | `setReply_dp3`? ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L470-L499)) / コマンド応答 (汎用)                           | -            | SET 系コマンドに対する成功/失敗の応答。`actionId`, `configOk` などのフィールドを持つ。応答ペイロードの具体的な構造は送信コマンドによる可能性あり。詳細は [proto 定義](mdc:scripts/ef_dp3_iobroker.proto#L470-L499)参照。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| `254`     | `23`    | `cmdFunc254_cmdId23_Report` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L434-L438))                                     | -            | `report_timestamp` などを持つ。具体的な用途は調査中。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |

## 送信メッセージ (アプリ/クラウド -> デバイス)

| `cmdFunc` | `cmdId`  | 機能概要 / Protobuf メッセージ型 (推測/定義)                                                                                                                                                                                                                  | 送信先 (dest) | 備考                                                                                                                                                                                                                                                      |
| --------- | -------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `20`      | `1`      | デバイスプロパティ取得要求 (Get ALL Quotas)                                                                                                                                                                                                                   | `32` (App?)   | デバイスの全設定値や状態値の一括取得を要求する。`cmdFunc:254, cmdId:21`, `cmdFunc:32, cmdId:2/50` などの応答が期待される。詳細は [issue_03 のログ解析](mdc:tasks/issues/issue_03_data_analysis_and_mapping_update.md#2025-05-29-1118-実行ログ解析) 参照。 |
| (各種)    | (各種)   | 設定変更系コマンド (例: AC 出力 ON/OFF, 充電上限 SOC 設定など)<br>使用メッセージ: `set_dp3` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L440-L468))<br>応答メッセージ: `setReply_dp3` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L470-L499)) | -             | 対応する `cmdId` や `cmdFunc` は `ioBroker.ecoflow-mqtt` の各デバイスドキュメント (例: `deltapro3.md` の "Set commands" セクション) を参照。`set_dp3` メッセージ内に設定したい項目と値を指定して送信。                                                    |
| (調査中)  | (調査中) | 時刻設定<br>使用メッセージ: `RTCTimeSet` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L602-L605))<br>応答メッセージ: `RTCTimeSetAck` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L606-L608))                                                   | -             | デバイスの RTC 時刻を設定する。                                                                                                                                                                                                                           |
| (調査中)  | (調査中) | 製品名設定<br>使用メッセージ: `ProductNameSet` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L586-L588))<br>応答メッセージ: `ProductNameSetAck` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L589-L591))                                         | -             | デバイスの製品名を設定する。                                                                                                                                                                                                                              |

## その他 (未分類・調査中)

| `cmdFunc` | `cmdId`  | 機能概要/Protobuf メッセージ型 (推測/定義)                                                               | 備考                                                                                                                                                                       |
| --------- | -------- | -------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| (調査中)  | (調査中) | イベント通知<br>`EventRecordReport` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L576-L580))      | デバイスから非同期に送信されるイベントやエラーログ。アプリ側は `EventInfoReportAck` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L581-L585)) で応答する可能性あり。 |
| (調査中)  | (調査中) | 製品名取得応答<br>`ProductNameGetAck` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L593-L595))    | `ProductNameGet` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L592-L592)) 要求に対する応答。                                                                        |
| (調査中)  | (調査中) | 時刻取得応答<br>`RTCTimeGetAck` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L598-L601))          | `RTCTimeGet` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L596-L596)) 要求に対する応答。                                                                            |
| (調査中)  | (調査中) | ハートビート<br>`SendMsgHart` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L616-L636))            | 接続維持や状態確認のために定期的に送受信されるメッセージ。`cmd_func` および `cmd_id` を含むため、特定の組み合わせで送受信される。                                          |
|           |          | `Header` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L538-L564))                                 | 多くのメッセージに含まれる共通ヘッダー構造。`cmd_func`, `cmd_id`, `device_sn` などを含む。                                                                                 |
|           |          | `TimeTaskItemV2` ([proto 定義あり](mdc:scripts/ef_dp3_iobroker.proto#L220-L231)) および関連 enum/message | タイマー予約機能に関連するデータ構造。`DisplayPropertyUpload` 内に含まれる `current_time_task_v2_item` や、専用の `cmdId`/`cmdFunc` で送受信される可能性がある。           |

---

このドキュメントは継続的に更新されます。
